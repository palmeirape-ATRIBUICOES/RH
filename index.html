<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>RH Simples - Auto Sync</title>

  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @media print { .no-print { display:none !important; } body { background:#fff !important; } }
    .help { font-size: 12px; color: rgb(100 116 139); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
    <div class="min-w-0">
      <div class="font-bold truncate">RH Simples</div>
      <div class="text-xs text-slate-500" id="hdrSub">Offline + Auto Sync Firebase</div>
    </div>

    <div class="flex items-center gap-2">
      <button id="btnInstall" class="hidden no-print px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">Instalar</button>
      <button id="btnLogout" class="hidden no-print px-3 py-2 rounded-xl border border-slate-300 text-sm">Sair</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-5">
  <!-- LOGIN -->
  <section id="viewLogin" class="max-w-lg mx-auto">
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
      <h1 class="text-xl font-bold">Entrar</h1>
      <p class="text-sm text-slate-600 mt-1">
        Cada gerente acessa apenas sua loja:
        <span class="font-semibold">MANA DE DEUS (Mana Thiago)</span> e
        <span class="font-semibold">BOGADOS PADARIA (Ellen)</span>.
      </p>

      <div class="mt-4 grid gap-3">
        <label class="text-sm">
          <span class="block text-slate-600 mb-1">Perfil</span>
          <select id="loginUser" class="w-full rounded-xl border border-slate-300 px-3 py-2">
            <option value="mana_thiago">Mana Thiago (MANA DE DEUS)</option>
            <option value="bogados_ellen">Ellen (BOGADOS PADARIA)</option>
          </select>
        </label>

        <label class="text-sm">
          <span class="block text-slate-600 mb-1">PIN</span>
          <input id="loginPin" type="password" inputmode="numeric"
                 class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Ex.: 1234" />
        </label>

        <button id="btnLogin" class="mt-1 w-full rounded-xl bg-slate-900 text-white px-4 py-2 font-semibold">
          Entrar
        </button>

        <div class="text-xs text-slate-500">
          Primeiro uso (padr√£o): <span class="font-semibold">Mana Thiago = 1234</span> ‚Ä¢
          <span class="font-semibold">Ellen = 4321</span>.
        </div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="viewApp" class="hidden">
    <div class="grid lg:grid-cols-12 gap-4">
      <!-- Sidebar -->
      <aside class="lg:col-span-3">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
          <div class="text-sm text-slate-500">Logado como</div>
          <div class="font-bold" id="whoami">‚Äî</div>
          <div class="text-sm mt-1">
            Loja: <span class="font-semibold" id="storeName">‚Äî</span>
          </div>

          <div class="mt-4 grid gap-2 no-print">
            <button class="tabBtn px-3 py-2 rounded-xl border border-slate-300 text-sm text-left" data-tab="employees">üë• Funcion√°rios</button>
            <button class="tabBtn px-3 py-2 rounded-xl border border-slate-300 text-sm text-left" data-tab="calc">üßÆ Rescis√£o</button>
            <button class="tabBtn px-3 py-2 rounded-xl border border-slate-300 text-sm text-left" data-tab="settings">‚öôÔ∏è Config</button>
          </div>
        </div>

        <div class="mt-4 bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
          <div class="text-sm font-semibold">Status Sync</div>
          <div class="mt-2 text-xs text-slate-500" id="fbStatus">Firebase: desconectado</div>
          <div class="mt-1 text-xs text-slate-500" id="netStatus">Internet: ‚Äî</div>
        </div>

        <div class="mt-4 bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
          <div class="text-sm font-semibold">Padr√£o de pagamento</div>
          <div class="text-xs text-slate-600 mt-1">
            Sal√°rio atual: <b>R$ 1650</b> (R$ 650 dia 20 + R$ 1000 dia 05).<br/>
            Descontos do ‚Äúcaderno‚Äù: sempre no dia <b>05</b>.
          </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="lg:col-span-9">
        <!-- Funcion√°rios -->
        <div id="tab_employees" class="tabPanel">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <div class="flex flex-col md:flex-row md:items-center gap-3 md:justify-between">
              <div>
                <h2 class="text-xl font-bold">Funcion√°rios</h2>
                <p class="text-sm text-slate-600">
                  Clique no nome para abrir o <b>drop-down</b> com hist√≥rico e lan√ßamentos.
                </p>
              </div>
              <div class="flex gap-2 no-print">
                <button id="btnNewEmp" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">+ Novo</button>
                <button id="btnToggleDismissed" class="px-3 py-2 rounded-xl border border-slate-300 text-sm">Ver demitidos</button>
              </div>
            </div>

            <div class="mt-4 grid md:grid-cols-3 gap-3 no-print">
              <input id="empSearch" class="md:col-span-2 w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Buscar por nome..." />
              <select id="empSort" class="w-full rounded-xl border border-slate-300 px-3 py-2">
                <option value="name">Ordenar: Nome</option>
                <option value="admission">Ordenar: Data de entrada</option>
              </select>
            </div>

            <div class="mt-4 overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-slate-500">
                <tr class="border-b">
                  <th class="text-left py-2">Funcion√°rio</th>
                  <th class="text-left py-2">Entrada</th>
                  <th class="text-left py-2">Sal√°rio atual</th>
                  <th class="text-left py-2">Caderno (pendente)</th>
                  <th class="text-right py-2 no-print">A√ß√µes</th>
                </tr>
                </thead>
                <tbody id="empTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Editor -->
          <div id="empEditorWrap" class="hidden mt-4 bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h3 class="text-lg font-bold" id="empEditorTitle">Novo funcion√°rio</h3>
                <p class="text-sm text-slate-600">Tudo sincroniza automaticamente.</p>
              </div>
              <button id="btnCloseEmpEditor" class="no-print px-3 py-2 rounded-xl border border-slate-300 text-sm">Fechar</button>
            </div>

            <div class="mt-4 grid md:grid-cols-2 gap-3">
              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Nome</span>
                <input id="empName" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Nome do funcion√°rio" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Data de entrada (DD/MM/AAAA)</span>
                <input id="empAdmission" inputmode="numeric"
                       class="w-full rounded-xl border border-slate-300 px-3 py-2"
                       placeholder="05/02/2026" />
                <div class="help mt-1">Padr√£o recomendado: sempre dia 05 (como voc√™ faz).</div>
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Sal√°rio atual (R$)</span>
                <input id="empSalary" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="1650" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Empr√©stimo atual (R$) (para rescis√£o)</span>
                <input id="empLoan" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="0" />
              </label>
            </div>

            <!-- PAGAMENTOS (2x no ciclo) -->
            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div>
                  <div class="text-sm font-semibold">Pagamentos (Dia 20 e Dia 05)</div>
                  <div class="text-xs text-slate-600 mt-1">
                    Dia 20: R$ 650 (05‚Üí20) ‚Ä¢ Dia 05: R$ 1000 (20‚Üí05) com desconto do caderno.
                  </div>
                </div>
              </div>

              <div class="mt-3 grid md:grid-cols-6 gap-3 no-print">
                <label class="text-sm md:col-span-2">
                  <span class="block text-slate-600 mb-1">Data do pagamento (DD/MM/AAAA)</span>
                  <input id="pay2Date" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="20/02/2026" />
                </label>

                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Tipo</span>
                  <select id="pay2Type" class="w-full rounded-xl border border-slate-300 px-3 py-2">
                    <option value="PAG20">Dia 20</option>
                    <option value="PAG05">Dia 05</option>
                  </select>
                </label>

                <label class="text-sm md:col-span-2">
                  <span class="block text-slate-600 mb-1">Valor bruto (R$)</span>
                  <input id="pay2Gross" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="650 ou 1000" />
                  <div class="help mt-1">Sugest√£o: 650 (Dia 20) / 1000 (Dia 05)</div>
                </label>

                <label class="text-sm flex items-end gap-2">
                  <input id="pay2AlsoDiscountOn20" type="checkbox" class="h-4 w-4" />
                  <span class="text-xs text-slate-600">Descontar no dia 20 tamb√©m</span>
                </label>

                <button id="btnRegisterPay" class="md:col-span-6 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">
                  + Registrar pagamento
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Hist√≥rico</th>
                    <th class="text-right py-2 no-print">A√ß√µes</th>
                  </tr>
                  </thead>
                  <tbody id="paymentsTable"></tbody>
                </table>
              </div>
            </div>

            <!-- CADERNO (DESCONTOS) -->
            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
              <div class="text-sm font-semibold">Caderno (descontos)</div>
              <div class="text-xs text-slate-600 mt-1">
                Registre tudo que ela pegou. No pagamento do <b>dia 05</b>, o sistema desconta automaticamente os pendentes.
              </div>

              <div class="mt-3 grid md:grid-cols-6 gap-3 no-print">
                <label class="text-sm md:col-span-2">
                  <span class="block text-slate-600 mb-1">Data (DD/MM/AAAA)</span>
                  <input id="ledDate" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="03/02/2026" />
                </label>
                <label class="text-sm md:col-span-3">
                  <span class="block text-slate-600 mb-1">Descri√ß√£o</span>
                  <input id="ledDesc" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Ex.: Caf√© / p√£o / produto" />
                </label>
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Valor (R$)</span>
                  <input id="ledAmount" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="12.50" />
                </label>

                <button id="btnAddLedger" class="md:col-span-6 px-4 py-2 rounded-xl border border-slate-300 bg-white font-semibold">
                  + Adicionar item no caderno
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Itens</th>
                    <th class="text-right py-2 no-print">A√ß√µes</th>
                  </tr>
                  </thead>
                  <tbody id="ledgerTable"></tbody>
                </table>
              </div>
            </div>

            <!-- F√âRIAS -->
            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
              <div class="text-sm font-semibold">F√©rias (per√≠odos)</div>

              <div class="mt-3 grid md:grid-cols-4 gap-3 no-print">
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">In√≠cio</span>
                  <input id="vacStart" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="15/01/2024" />
                </label>
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Fim</span>
                  <input id="vacEnd" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="14/02/2024" />
                </label>
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Valor pago (R$)</span>
                  <input id="vacPaidValue" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="2500" />
                </label>
                <button id="btnAddVacation" class="mt-6 md:mt-0 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">
                  + Adicionar f√©rias
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Texto</th>
                    <th class="text-right py-2 no-print">A√ß√µes</th>
                  </tr>
                  </thead>
                  <tbody id="vacationsTable"></tbody>
                </table>
              </div>
            </div>

            <!-- 13¬∫ -->
            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
              <div class="text-sm font-semibold">13¬∫ sal√°rio (ano + data)</div>

              <div class="mt-3 grid md:grid-cols-3 gap-3 no-print">
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Ano</span>
                  <input id="thYear" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="2024" />
                </label>
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Data do pagamento</span>
                  <input id="thDate" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="20/12/2024" />
                </label>
                <button id="btnAddTh" class="mt-6 md:mt-0 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">
                  + Registrar 13¬∫
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Texto</th>
                    <th class="text-right py-2 no-print">A√ß√µes</th>
                  </tr>
                  </thead>
                  <tbody id="thTable"></tbody>
                </table>
              </div>
            </div>

            <!-- COMPRA F√âRIAS -->
            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
              <div class="text-sm font-semibold">Compra de f√©rias (data)</div>

              <div class="mt-3 grid md:grid-cols-3 gap-3 no-print">
                <label class="text-sm md:col-span-2">
                  <span class="block text-slate-600 mb-1">Data</span>
                  <input id="buyVacDate" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="10/01/2025" />
                </label>
                <button id="btnAddBuyVac" class="mt-6 md:mt-0 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">
                  + Registrar compra
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Texto</th>
                    <th class="text-right py-2 no-print">A√ß√µes</th>
                  </tr>
                  </thead>
                  <tbody id="buyVacTable"></tbody>
                </table>
              </div>
            </div>

            <!-- STATUS -->
            <div class="mt-4 text-sm">
              <div class="text-slate-600">Status</div>
              <div class="flex flex-wrap items-center gap-3 mt-1">
                <label class="inline-flex items-center gap-2">
                  <input id="empActive" type="checkbox" class="h-4 w-4" checked />
                  <span>Ativo</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <span class="text-slate-600">Data de demiss√£o (DD/MM/AAAA)</span>
                  <input id="empDismissal" inputmode="numeric" class="rounded-xl border border-slate-300 px-3 py-2" placeholder="10/02/2026" />
                </label>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2 no-print">
              <button id="btnSaveEmp" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">Salvar</button>
              <button id="btnAddSalaryChange" class="px-4 py-2 rounded-xl border border-slate-300">Registrar mudan√ßa de sal√°rio</button>
              <button id="btnArchiveEmp" class="px-4 py-2 rounded-xl border border-amber-300 text-amber-700">Arquivar (demitido)</button>
              <button id="btnDeleteEmp" class="px-4 py-2 rounded-xl border border-rose-300 text-rose-700">Excluir</button>
            </div>

            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-3">
              <div class="text-sm font-semibold">Hist√≥rico de sal√°rio (altera√ß√µes)</div>
              <div class="mt-2 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Data</th>
                    <th class="text-left py-2">Sal√°rio (R$)</th>
                  </tr>
                  </thead>
                  <tbody id="salaryHistoryTable"></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>

        <!-- Rescis√£o -->
        <div id="tab_calc" class="tabPanel hidden">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <h2 class="text-xl font-bold">C√°lculo de Rescis√£o (simples)</h2>

            <div class="mt-4 grid md:grid-cols-3 gap-3 no-print">
              <label class="text-sm md:col-span-2">
                <span class="block text-slate-600 mb-1">Funcion√°rio</span>
                <select id="calcEmp" class="w-full rounded-xl border border-slate-300 px-3 py-2"></select>
              </label>
              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Data de desligamento</span>
                <input id="calcDate" type="date" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Tipo</span>
                <select id="calcType" class="w-full rounded-xl border border-slate-300 px-3 py-2">
                  <option value="sem_justa_causa">Sem justa causa</option>
                  <option value="pedido_demissao">Pedido de demiss√£o</option>
                  <option value="acordo">Acordo (metade aviso + 20% FGTS)</option>
                </select>
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Dias trabalhados no m√™s</span>
                <input id="calcDaysWorked" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="15" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Meses p/ f√©rias proporcionais (0‚Äì12)</span>
                <input id="calcVacMonths" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="0" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">F√©rias vencidas? (0 ou 1 per√≠odo)</span>
                <input id="calcVacOverdue" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="0" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Aviso pr√©vio indenizado (dias)</span>
                <input id="calcNoticeDays" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="30" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Saldo FGTS (R$) (para multa)</span>
                <input id="calcFgtsBalance" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="0" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Desconto empr√©stimo (R$)</span>
                <input id="calcLoanDiscount" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="0" />
              </label>
            </div>

            <div class="mt-4 flex flex-wrap gap-3 items-center no-print">
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="optInss" type="checkbox" class="h-4 w-4" checked />
                <span>Incluir INSS</span>
              </label>
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="optFgts" type="checkbox" class="h-4 w-4" checked />
                <span>Incluir multa FGTS</span>
              </label>

              <button id="btnCalc" class="ml-auto px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">Calcular</button>
              <button id="btnPdf" class="px-4 py-2 rounded-xl border border-slate-300">Exportar PDF</button>
            </div>

            <div class="mt-4 border-t border-slate-200 pt-4">
              <div id="calcResult" class="text-sm text-slate-700"></div>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div id="tab_settings" class="tabPanel hidden">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <h2 class="text-xl font-bold">Config</h2>

            <div class="mt-4 grid md:grid-cols-2 gap-3 no-print">
              <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                <div class="font-semibold">Trocar PIN</div>
                <label class="text-sm block mt-3">
                  <span class="block text-slate-600 mb-1">PIN atual</span>
                  <input id="pinOld" type="password" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </label>
                <label class="text-sm block mt-2">
                  <span class="block text-slate-600 mb-1">Novo PIN</span>
                  <input id="pinNew" type="password" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </label>
                <button id="btnChangePin" class="mt-3 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">Salvar PIN</button>
              </div>

              <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                <div class="font-semibold">Firebase (Definitivo)</div>
                <div class="text-sm text-slate-600 mt-1">
                  Use <b>Email/Senha</b> para sincroniza√ß√£o autom√°tica por anos.
                </div>

                <label class="text-sm block mt-3">
                  <span class="block text-slate-600 mb-1">Email</span>
                  <input id="fbEmail" type="email" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="ex.: mana@seudominio.com" />
                </label>
                <label class="text-sm block mt-2">
                  <span class="block text-slate-600 mb-1">Senha</span>
                  <input id="fbPass" type="password" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                </label>

                <div class="mt-3 flex flex-wrap gap-2">
                  <button id="btnFbSignIn" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">Conectar</button>
                  <button id="btnFbSignOut" class="px-4 py-2 rounded-xl border border-slate-300">Desconectar</button>
                </div>

                <div class="mt-2 text-xs text-slate-500">
                  Ap√≥s conectar, tudo sincroniza em tempo real (offline tamb√©m).
                </div>
              </div>
            </div>

            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4 no-print">
              <div class="font-semibold">Backup local (extra)</div>
              <div class="text-sm text-slate-600 mt-1">Se quiser: exportar/importar JSON.</div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="btnExport" class="px-4 py-2 rounded-xl border border-slate-300">Exportar JSON</button>
                <label class="px-4 py-2 rounded-xl border border-slate-300 cursor-pointer">
                  Importar JSON
                  <input id="fileImport" type="file" accept="application/json" class="hidden" />
                </label>
                <button id="btnReset" class="px-4 py-2 rounded-xl border border-rose-300 text-rose-700">Reset loja</button>
              </div>
            </div>

          </div>
        </div>

      </section>
    </div>
  </section>
</main>

<script type="module">
/* =========================================================
   Firebase (CDN modular)
   ========================================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot,
  enableIndexedDbPersistence
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, signOut,
  signInWithEmailAndPassword, createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

/* === Seu firebaseConfig === */
const firebaseConfig = {
  apiKey: "AIzaSyCN6TZYTw4wQlAVnsB7uJZtG8KsTTxKJ94",
  authDomain: "thrh-640ab.firebaseapp.com",
  projectId: "thrh-640ab",
  storageBucket: "thrh-640ab.firebasestorage.app",
  messagingSenderId: "1004522826863",
  appId: "1:1004522826863:web:0e3a8e6a0a053dfcdfb19a"
};

/* ========= PWA Manifest via blob (sem start_url para evitar erro) ========= */
(function setupPWA(){
  try {
    const manifest = {
      name:"RH Simples",
      short_name:"RH",
      display:"standalone",
      background_color:"#f8fafc",
      theme_color:"#0f172a"
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement("link");
    link.rel = "manifest";
    link.href = url;
    document.head.appendChild(link);
  } catch {}

  let deferredPrompt = null;
  const btnInstall = document.getElementById("btnInstall");
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    btnInstall.classList.remove("hidden");
  });
  btnInstall.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    deferredPrompt = null;
    btnInstall.classList.add("hidden");
  });
})();

/* ========= Helpers ========= */
const LS_KEY = "pwa_rh_autosync_v2";
const SESSION_KEY = "pwa_rh_session_v1";

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function safeNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
function formatBRL(n){ return Number(n||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }
function escapeHTML(str){
  return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function todayISO(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function formatISOToBR(iso){
  if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return "";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}
function parseBRToISO(br){
  const s = String(br||"").trim();
  const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (!m) return null;
  const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
  if (yy < 1900 || yy > 2100) return null;
  if (mm < 1 || mm > 12) return null;
  if (dd < 1 || dd > 31) return null;
  const iso = `${yy}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
  const dt = new Date(iso + "T00:00:00");
  const ok = dt.getFullYear()===yy && (dt.getMonth()+1)===mm && dt.getDate()===dd;
  return ok ? iso : null;
}
function normalizeBRDateInput(el){
  const iso = parseBRToISO(el.value);
  if (!iso) return false;
  el.value = formatISOToBR(iso);
  return true;
}
async function hashPin(text){
  text = String(text ?? "");
  if (window.crypto && crypto.subtle && window.isSecureContext) {
    const enc = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,"0")).join("");
  }
  let h = 5381;
  for (let i = 0; i < text.length; i++) h = ((h << 5) + h) + text.charCodeAt(i);
  return "fb_" + (h >>> 0).toString(16);
}
function fmtMonth(m){ return String(m).padStart(2,"0"); }

/* ========= Pagamentos 20/05 ========= */
function isoFromYMD(y,m,d){ return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`; }
function addMonthsISO(iso, delta){
  const dt = new Date(iso+"T00:00:00");
  dt.setMonth(dt.getMonth()+delta);
  return isoFromYMD(dt.getFullYear(), dt.getMonth()+1, dt.getDate());
}
function computePayPeriod(payType, payDateISO){
  const [Y,M] = payDateISO.split("-").map(Number);

  if (payType === "PAG20"){
    return { start: isoFromYMD(Y,M,5), end: isoFromYMD(Y,M,20) };
  }
  // PAG05: 20/(MM-1) -> 05/MM
  const thisMonth05 = isoFromYMD(Y,M,5);
  const prevMonth05 = addMonthsISO(thisMonth05, -1);
  const [y2,m2] = prevMonth05.split("-").map(Number);
  return { start: isoFromYMD(y2,m2,20), end: thisMonth05 };
}

/* ========= Local DB ========= */
function defaultDB(){
  return {
    version: 2,
    stores: {
      mana: {
        name: "MANA DE DEUS",
        managers: { mana_thiago: { label: "Mana Thiago", pinHash: null } },
        employees: []
      },
      bogados: {
        name: "BOGADOS PADARIA",
        managers: { bogados_ellen: { label: "Ellen", pinHash: null } },
        employees: []
      }
    }
  };
}
function loadDB(){
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return defaultDB();
  try { return JSON.parse(raw); } catch { return defaultDB(); }
}
function saveDB(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

async function ensureDefaultPins(){
  const db = loadDB();
  const manaMgr = db.stores.mana.managers.mana_thiago;
  const bogMgr  = db.stores.bogados.managers.bogados_ellen;
  if (!manaMgr.pinHash) manaMgr.pinHash = await hashPin("1234");
  if (!bogMgr.pinHash)  bogMgr.pinHash  = await hashPin("4321");
  saveDB(db);
}

function setSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
function getSession(){
  const raw = localStorage.getItem(SESSION_KEY);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function clearSession(){ localStorage.removeItem(SESSION_KEY); }

function resolveStoreFromUser(user){
  if (user === "mana_thiago") return "mana";
  if (user === "bogados_ellen") return "bogados";
  return null;
}
function getStoreCtx(){
  const s = getSession();
  if (!s) return null;
  const db = loadDB();
  return { session: s, db, storeKey: s.storeKey, store: db.stores[s.storeKey] };
}

/* ========= Employee shape + migra√ß√£o ========= */
function ensureEmpShape(emp){
  emp.vacations = emp.vacations || [];
  emp.thirteenthPayments = emp.thirteenthPayments || {};
  emp.boughtVacations = emp.boughtVacations || [];
  emp.salaryHistory = emp.salaryHistory || [];
  emp.loanBalance = safeNum(emp.loanBalance);
  emp.status = emp.status || "active";
  emp.updatedAt = safeNum(emp.updatedAt) || 0;

  // NOVO: caderno e pagamentos
  emp.ledger = emp.ledger || [];     // itens pendentes/descontados
  emp.payments = emp.payments || []; // registros de pagamento 20/05

  // Migra√ß√£o: se existir salaryPayments antigo, transforma em payments simples (sem descontos)
  if (Array.isArray(emp.salaryPayments) && emp.salaryPayments.length){
    const alreadyMigrated = emp.payments && emp.payments.some(p => p.migratedFrom === "salaryPayments");
    if (!alreadyMigrated){
      emp.salaryPayments.forEach(sp=>{
        const payDateISO = sp.paidDateISO || todayISO();
        // inferir tipo: se dia 5 -> PAG05, se dia 20 -> PAG20 (sen√£o "OUTRO")
        const day = Number((payDateISO.split("-")[2]||"0"));
        let type = "OUTRO";
        if (day === 5) type = "PAG05";
        if (day === 20) type = "PAG20";
        const period = (type==="PAG05"||type==="PAG20") ? computePayPeriod(type, payDateISO) : { start:"", end:"" };
        emp.payments.push({
          id: uid(),
          payDateISO,
          type,
          periodStartISO: period.start,
          periodEndISO: period.end,
          gross: safeNum(sp.amount),
          discountsTotal: 0,
          net: safeNum(sp.amount),
          discountItems: [],
          migratedFrom: "salaryPayments"
        });
      });
      emp.salaryPayments = []; // limpa antigo
    }
  }

  return emp;
}
function getEmpById(store, id){ return (store.employees || []).find(e=>e.id===id) || null; }
function upsertEmp(store, emp){
  store.employees = store.employees || [];
  const idx = store.employees.findIndex(e=>e.id===emp.id);
  if (idx >= 0) store.employees[idx] = emp;
  else store.employees.push(emp);
}
function currentSalary(emp){
  if (!emp.salaryHistory?.length) return safeNum(emp.salary || 0);
  const sorted = [...emp.salaryHistory].sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  return safeNum(sorted[sorted.length-1].salary);
}
function sumLedgerPending(emp){
  ensureEmpShape(emp);
  return emp.ledger.filter(x=>x.status==="pending").reduce((s,x)=>s+safeNum(x.amount),0);
}

/* ========= Ledger + Payments core ========= */
function addLedgerItem(emp, dateISO, desc, amount){
  ensureEmpShape(emp);
  emp.ledger.push({
    id: uid(),
    dateISO,
    desc: (desc||"").trim(),
    amount: safeNum(amount),
    status: "pending",
    deductedOnPaymentId: null
  });
  emp.updatedAt = Date.now();
}
function registerPayment(emp, payType, payDateISO, gross, alsoDiscountOn20=false){
  ensureEmpShape(emp);

  const useDiscounts = (payType==="PAG05") || (payType==="PAG20" && !!alsoDiscountOn20);
  const pending = useDiscounts
    ? emp.ledger.filter(x => x.status==="pending" && x.dateISO <= payDateISO)
    : [];

  const discountsTotal = pending.reduce((s,x)=>s+safeNum(x.amount),0);
  const net = safeNum(gross) - discountsTotal;

  const { start, end } = (payType==="PAG05"||payType==="PAG20") ? computePayPeriod(payType, payDateISO) : { start:"", end:"" };
  const paymentId = uid();

  pending.forEach(x=>{
    x.status = "deducted";
    x.deductedOnPaymentId = paymentId;
  });

  emp.payments.push({
    id: paymentId,
    payDateISO,
    type: payType,
    periodStartISO: start,
    periodEndISO: end,
    gross: safeNum(gross),
    discountsTotal,
    net,
    discountItems: pending.map(x=>({ ledgerId:x.id, desc:x.desc, amount:x.amount }))
  });

  emp.updatedAt = Date.now();
  return paymentId;
}

/* ========= Firebase (Auto Sync) ========= */
let fb = { app:null, db:null, auth:null, connected:false, user:null, unsubEmployees:null };
const fbStatus = document.getElementById("fbStatus");
const netStatus = document.getElementById("netStatus");
const hdrSub = document.getElementById("hdrSub");

function setFbStatus(txt){
  fbStatus.textContent = txt;
  hdrSub.textContent = `Offline + Auto Sync Firebase ‚Ä¢ ${txt}`;
}
function setNetStatus(){
  netStatus.textContent = `Internet: ${navigator.onLine ? "online ‚úÖ" : "offline ‚ö†Ô∏è"}`;
}
window.addEventListener("online", setNetStatus);
window.addEventListener("offline", setNetStatus);
setNetStatus();

function initFirebaseOnce(){
  if (fb.app) return;
  fb.app = initializeApp(firebaseConfig);
  fb.db = getFirestore(fb.app);
  fb.auth = getAuth(fb.app);

  enableIndexedDbPersistence(fb.db).catch(()=>{});

  onAuthStateChanged(fb.auth, (u)=>{
    fb.user = u || null;
    fb.connected = !!u;
    setFbStatus(u ? `Firebase: conectado ‚úÖ (${u.email || "conta"})` : "Firebase: desconectado");
    if (u) startAutoSync(); else stopAutoSync();
  });
}
function stopAutoSync(){
  if (fb.unsubEmployees) { fb.unsubEmployees(); fb.unsubEmployees = null; }
}
function shouldApplyRemote(localEmp, remoteEmp){
  const l = safeNum(localEmp?.updatedAt);
  const r = safeNum(remoteEmp?.updatedAt);
  return r > l;
}
function startAutoSync(){
  const ctx = getStoreCtx();
  if (!ctx) return;

  stopAutoSync();

  const colRef = collection(fb.db, "stores", ctx.storeKey, "employees");

  fb.unsubEmployees = onSnapshot(colRef, (snap)=>{
    const ctx2 = getStoreCtx();
    if (!ctx2) return;

    const store = ctx2.store;
    const localMap = new Map((store.employees||[]).map(e => [e.id, e]));

    snap.docChanges().forEach((ch)=>{
      const id = ch.doc.id;
      if (ch.type === "removed"){
        store.employees = (store.employees||[]).filter(e=>e.id !== id);
        return;
      }

      const remote = ch.doc.data();
      remote.id = remote.id || id;
      ensureEmpShape(remote);

      const local = localMap.get(remote.id);
      if (!local) {
        upsertEmp(store, remote);
      } else {
        ensureEmpShape(local);
        if (shouldApplyRemote(local, remote)) upsertEmp(store, remote);
      }
    });

    ctx2.db.stores[ctx2.storeKey] = store;
    saveDB(ctx2.db);
    renderEmployees();
    renderCalcEmployees();
  });
}
const pushTimers = new Map();
function schedulePushEmp(emp){
  if (!fb.connected || !fb.db || !fb.user) return;
  const ctx = getStoreCtx();
  if (!ctx) return;

  const key = emp.id;
  if (pushTimers.has(key)) clearTimeout(pushTimers.get(key));

  pushTimers.set(key, setTimeout(async ()=>{
    try {
      const ref = doc(fb.db, "stores", ctx.storeKey, "employees", emp.id);
      await setDoc(ref, emp, { merge:true });
    } catch (e) {
      console.error("push error:", e);
    }
  }, 350));
}
async function pushDeleteEmp(empId){
  if (!fb.connected || !fb.db) return;
  const ctx = getStoreCtx();
  if (!ctx) return;
  try {
    await deleteDoc(doc(fb.db, "stores", ctx.storeKey, "employees", empId));
  } catch (e) {
    console.error("delete error:", e);
  }
}

/* ========= UI refs ========= */
const viewLogin = document.getElementById("viewLogin");
const viewApp = document.getElementById("viewApp");
const btnLogout = document.getElementById("btnLogout");
const whoami = document.getElementById("whoami");
const storeName = document.getElementById("storeName");

const tabBtns = Array.from(document.querySelectorAll(".tabBtn"));
const tabPanels = {
  employees: document.getElementById("tab_employees"),
  calc: document.getElementById("tab_calc"),
  settings: document.getElementById("tab_settings"),
};

const empTable = document.getElementById("empTable");
const empSearch = document.getElementById("empSearch");
const empSort = document.getElementById("empSort");
const btnNewEmp = document.getElementById("btnNewEmp");
const btnToggleDismissed = document.getElementById("btnToggleDismissed");

const empEditorWrap = document.getElementById("empEditorWrap");
const empEditorTitle = document.getElementById("empEditorTitle");
const btnCloseEmpEditor = document.getElementById("btnCloseEmpEditor");
const empName = document.getElementById("empName");
const empAdmission = document.getElementById("empAdmission");
const empSalary = document.getElementById("empSalary");
const empLoan = document.getElementById("empLoan");

const pay2Date = document.getElementById("pay2Date");
const pay2Type = document.getElementById("pay2Type");
const pay2Gross = document.getElementById("pay2Gross");
const pay2AlsoDiscountOn20 = document.getElementById("pay2AlsoDiscountOn20");
const btnRegisterPay = document.getElementById("btnRegisterPay");
const paymentsTable = document.getElementById("paymentsTable");

const ledDate = document.getElementById("ledDate");
const ledDesc = document.getElementById("ledDesc");
const ledAmount = document.getElementById("ledAmount");
const btnAddLedger = document.getElementById("btnAddLedger");
const ledgerTable = document.getElementById("ledgerTable");

const vacStart = document.getElementById("vacStart");
const vacEnd = document.getElementById("vacEnd");
const vacPaidValue = document.getElementById("vacPaidValue");
const btnAddVacation = document.getElementById("btnAddVacation");
const vacationsTable = document.getElementById("vacationsTable");

const thYear = document.getElementById("thYear");
const thDate = document.getElementById("thDate");
const btnAddTh = document.getElementById("btnAddTh");
const thTable = document.getElementById("thTable");

const buyVacDate = document.getElementById("buyVacDate");
const btnAddBuyVac = document.getElementById("btnAddBuyVac");
const buyVacTable = document.getElementById("buyVacTable");

const empActive = document.getElementById("empActive");
const empDismissal = document.getElementById("empDismissal");
const btnSaveEmp = document.getElementById("btnSaveEmp");
const btnAddSalaryChange = document.getElementById("btnAddSalaryChange");
const btnArchiveEmp = document.getElementById("btnArchiveEmp");
const btnDeleteEmp = document.getElementById("btnDeleteEmp");
const salaryHistoryTable = document.getElementById("salaryHistoryTable");

const calcEmp = document.getElementById("calcEmp");
const calcDate = document.getElementById("calcDate");
const calcType = document.getElementById("calcType");
const calcDaysWorked = document.getElementById("calcDaysWorked");
const calcVacMonths = document.getElementById("calcVacMonths");
const calcVacOverdue = document.getElementById("calcVacOverdue");
const calcNoticeDays = document.getElementById("calcNoticeDays");
const calcFgtsBalance = document.getElementById("calcFgtsBalance");
const calcLoanDiscount = document.getElementById("calcLoanDiscount");
const btnCalc = document.getElementById("btnCalc");
const btnPdf = document.getElementById("btnPdf");
const calcResult = document.getElementById("calcResult");

/* Firebase UI */
const fbEmail = document.getElementById("fbEmail");
const fbPass = document.getElementById("fbPass");
const btnFbSignIn = document.getElementById("btnFbSignIn");
const btnFbSignOut = document.getElementById("btnFbSignOut");

/* Settings backup */
const pinOld = document.getElementById("pinOld");
const pinNew = document.getElementById("pinNew");
const btnChangePin = document.getElementById("btnChangePin");
const btnExport = document.getElementById("btnExport");
const fileImport = document.getElementById("fileImport");
const btnReset = document.getElementById("btnReset");

/* ========= Tabs/Auth ========= */
let currentTab = "employees";
let showDismissed = false;
let editingEmpId = null;

function openTab(tab){
  currentTab = tab;
  for (const k of Object.keys(tabPanels)){
    tabPanels[k].classList.toggle("hidden", k !== tab);
  }
  tabBtns.forEach(b=>{
    const active = b.dataset.tab === tab;
    b.classList.toggle("bg-slate-900", active);
    b.classList.toggle("text-white", active);
    b.classList.toggle("border-slate-900", active);
  });
  if (tab === "employees") renderEmployees();
  if (tab === "calc") renderCalcEmployees();
}

function requireAuth(){
  const s = getSession();
  if (!s) {
    viewApp.classList.add("hidden");
    viewLogin.classList.remove("hidden");
    btnLogout.classList.add("hidden");
    stopAutoSync();
    return false;
  }
  viewLogin.classList.add("hidden");
  viewApp.classList.remove("hidden");
  btnLogout.classList.remove("hidden");

  const ctx = getStoreCtx();
  whoami.textContent = ctx.store.managers[s.userKey].label;
  storeName.textContent = ctx.store.name;

  if (fb.connected) startAutoSync();

  openTab(currentTab);
  return true;
}

/* ========= Drop-down (detalhes) ========= */
window.__toggleDetails = (id) => {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle("hidden");
};

function renderEmployeeDetails(emp){
  ensureEmpShape(emp);

  const pendingSum = sumLedgerPending(emp);
  const pendingItems = emp.ledger.filter(x=>x.status==="pending").sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
  const payments = (emp.payments||[]).slice().sort((a,b)=> (a.payDateISO||"").localeCompare(b.payDateISO||""));
  const vacs = (emp.vacations||[]).slice().sort((a,b)=> (a.startISO||"").localeCompare(b.startISO||""));
  const thYears = Object.keys(emp.thirteenthPayments||{}).sort((a,b)=> Number(a)-Number(b));
  const buys = (emp.boughtVacations||[]).slice().sort();

  const pendingLines = pendingItems.length
    ? pendingItems.map(x=> `Pendente ${formatISOToBR(x.dateISO)}: ${x.desc} (${formatBRL(x.amount)})`)
    : ["Nenhum desconto pendente."];

  const payLines = payments.length
    ? payments.map(p=>{
        const typ = p.type==="PAG20" ? "Pagamento dia 20" : (p.type==="PAG05" ? "Pagamento dia 05" : "Pagamento");
        const period = (p.periodStartISO && p.periodEndISO) ? ` ‚Ä¢ per√≠odo ${formatISOToBR(p.periodStartISO)} a ${formatISOToBR(p.periodEndISO)}` : "";
        const disc = p.discountsTotal ? ` ‚Ä¢ descontos ${formatBRL(p.discountsTotal)}` : "";
        return `${typ} em ${formatISOToBR(p.payDateISO)}${period} ‚Ä¢ bruto ${formatBRL(p.gross)}${disc} ‚Ä¢ l√≠quido ${formatBRL(p.net)}`;
      })
    : ["Nenhum pagamento registrado."];

  const vacLines = vacs.length
    ? vacs.map((v,i)=> `Tirou ${i+1} f√©rias no per√≠odo ${formatISOToBR(v.startISO)} a ${formatISOToBR(v.endISO)} (${formatBRL(v.paidValue)})`)
    : ["Nenhuma f√©rias registrada."];

  const thLines = thYears.length
    ? thYears.map(y => `13¬∫ do ano de ${y} foi pago na data ${formatISOToBR(emp.thirteenthPayments[y])}`)
    : ["Nenhum 13¬∫ registrado."];

  const buyLines = buys.length
    ? buys.map(d => `Comprei as f√©rias na data ${formatISOToBR(d)}`)
    : ["Nenhuma compra de f√©rias registrada."];

  function ul(lines){
    return `<ul class="list-disc pl-5 space-y-1">${lines.map(t=>`<li>${escapeHTML(t)}</li>`).join("")}</ul>`;
  }

  return `
    <div class="mt-2 bg-slate-50 border border-slate-200 rounded-2xl p-3">
      <div class="text-sm font-semibold text-slate-700">Resumo r√°pido</div>
      <div class="text-xs text-slate-600 mt-1">Caderno pendente: <b>${formatBRL(pendingSum)}</b></div>

      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <div>
          <div class="text-xs text-slate-500 font-semibold mb-1">PAGAMENTOS</div>
          <div class="text-sm text-slate-700">${ul(payLines)}</div>
        </div>
        <div>
          <div class="text-xs text-slate-500 font-semibold mb-1">CADERNO (PENDENTE)</div>
          <div class="text-sm text-slate-700">${ul(pendingLines)}</div>
        </div>
        <div>
          <div class="text-xs text-slate-500 font-semibold mb-1">F√âRIAS</div>
          <div class="text-sm text-slate-700">${ul(vacLines)}</div>
        </div>
        <div>
          <div class="text-xs text-slate-500 font-semibold mb-1">13¬∫ / COMPRA DE F√âRIAS</div>
          <div class="text-sm text-slate-700">${ul(thLines.concat(buyLines))}</div>
        </div>
      </div>
      <div class="mt-3 text-xs text-slate-500">Para lan√ßar itens/pagamentos, clique em <b>Editar</b>.</div>
    </div>
  `;
}

/* ========= Lista ========= */
function listEmployeesForUI(){
  const ctx = getStoreCtx();
  const emps = ctx.store.employees || [];
  const q = (empSearch.value || "").trim().toLowerCase();

  let filtered = emps.filter(e => {
    ensureEmpShape(e);
    const isDismissed = e.status === "dismissed";
    if (!showDismissed && isDismissed) return false;
    if (showDismissed && !isDismissed) return false;
    if (q && !(e.name || "").toLowerCase().includes(q)) return false;
    return true;
  });

  const sortBy = empSort.value;
  filtered.sort((a,b)=>{
    if (sortBy === "name") return (a.name||"").localeCompare(b.name||"");
    if (sortBy === "admission") return (a.admissionDate||"").localeCompare(b.admissionDate||"");
    return 0;
  });

  return filtered;
}

function renderEmployees(){
  const rows = listEmployeesForUI();
  btnToggleDismissed.textContent = showDismissed ? "Ver ativos" : "Ver demitidos";

  empTable.innerHTML = rows.map(e=>{
    const sal = currentSalary(e) || 1650;
    const pending = sumLedgerPending(e);
    const detailsId = `det_${e.id.replaceAll(/[^a-zA-Z0-9]/g,"")}`;
    return `
      <tr class="border-b">
        <td class="py-2">
          <button class="text-left font-semibold underline decoration-dotted" onclick="window.__toggleDetails('${detailsId}')">
            ${escapeHTML(e.name || "")}
          </button>
          <div class="text-xs text-slate-500 mt-0.5">clique no nome para ver hist√≥rico</div>
        </td>
        <td class="py-2">${formatISOToBR(e.admissionDate) || "‚Äî"}</td>
        <td class="py-2">${formatBRL(sal)}</td>
        <td class="py-2">${formatBRL(pending)}</td>
        <td class="py-2 text-right no-print">
          <button class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs" onclick="window.__openEmpEditor('${e.id}')">
            Editar
          </button>
        </td>
      </tr>
      <tr class="border-b last:border-b-0">
        <td colspan="5" class="pb-3">
          <div id="${detailsId}" class="hidden">${renderEmployeeDetails(e)}</div>
        </td>
      </tr>
    `;
  }).join("");

  empEditorWrap.classList.add("hidden");
  editingEmpId = null;
}

/* ========= Editor renderers ========= */
function renderSalaryHistory(emp){
  const hist = (emp.salaryHistory || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  salaryHistoryTable.innerHTML = hist.map(h=>`
    <tr class="border-b last:border-b-0">
      <td class="py-2">${formatISOToBR(h.date) || "‚Äî"}</td>
      <td class="py-2">${formatBRL(h.salary)}</td>
    </tr>
  `).join("");
}

function renderPayments(emp){
  ensureEmpShape(emp);
  const list = (emp.payments || []).slice().sort((a,b)=> (a.payDateISO||"").localeCompare(b.payDateISO||""));
  if (!list.length){
    paymentsTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhum pagamento registrado.</td></tr>`;
    return;
  }
  paymentsTable.innerHTML = list.map((p,idx)=>{
    const typ = p.type==="PAG20" ? "Pagamento dia 20" : (p.type==="PAG05" ? "Pagamento dia 05" : "Pagamento");
    const period = (p.periodStartISO && p.periodEndISO) ? `per√≠odo ${formatISOToBR(p.periodStartISO)} ‚Üí ${formatISOToBR(p.periodEndISO)}` : "per√≠odo ‚Äî";
    const disc = p.discountsTotal ? ` ‚Ä¢ descontos ${formatBRL(p.discountsTotal)}` : "";
    const text = `${typ} em ${formatISOToBR(p.payDateISO)} ‚Ä¢ ${period} ‚Ä¢ bruto ${formatBRL(p.gross)}${disc} ‚Ä¢ l√≠quido ${formatBRL(p.net)}`;
    return `
      <tr class="border-b last:border-b-0">
        <td class="py-2">${escapeHTML(text)}</td>
        <td class="py-2 text-right no-print">
          <button class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs"
            onclick="window.__deletePayment('${emp.id}', ${idx})">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");
}

function renderLedger(emp){
  ensureEmpShape(emp);
  const list = (emp.ledger || []).slice().sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
  if (!list.length){
    ledgerTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhum item no caderno.</td></tr>`;
    return;
  }
  ledgerTable.innerHTML = list.map((x,idx)=>{
    const status = x.status==="pending" ? "PENDENTE" : "DESCONTADO";
    const badge = x.status==="pending"
      ? `<span class="px-2 py-1 rounded-lg bg-amber-100 text-amber-800 text-xs font-semibold">PENDENTE</span>`
      : `<span class="px-2 py-1 rounded-lg bg-emerald-100 text-emerald-800 text-xs font-semibold">DESCONTADO</span>`;
    const extra = x.status==="deducted" && x.deductedOnPaymentId
      ? ` (no pagamento ${x.deductedOnPaymentId.slice(-6)})`
      : "";
    const text = `${formatISOToBR(x.dateISO)} ‚Ä¢ ${x.desc} ‚Ä¢ ${formatBRL(x.amount)} ${extra}`;
    return `
      <tr class="border-b last:border-b-0">
        <td class="py-2">
          <div class="flex items-center gap-2">
            ${badge}
            <div>${escapeHTML(text)}</div>
          </div>
        </td>
        <td class="py-2 text-right no-print">
          ${x.status==="pending"
            ? `<button class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs"
                 onclick="window.__deleteLedger('${emp.id}', ${idx})">Excluir</button>`
            : `<button class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs"
                 onclick="window.__undoLedger('${emp.id}', ${idx})">Voltar p/ pendente</button>`
          }
        </td>
      </tr>
    `;
  }).join("");
}

function renderVacations(emp){
  const list = (emp.vacations || []).slice().sort((a,b)=> (a.startISO||"").localeCompare(b.startISO||""));
  if (!list.length){
    vacationsTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhuma f√©rias registrada.</td></tr>`;
    return;
  }
  vacationsTable.innerHTML = list.map((v,idx)=>{
    const text = `Tirou ${idx+1} f√©rias no per√≠odo ${formatISOToBR(v.startISO)} a ${formatISOToBR(v.endISO)} (${formatBRL(v.paidValue)})`;
    return `
      <tr class="border-b last:border-b-0">
        <td class="py-2">${escapeHTML(text)}</td>
        <td class="py-2 text-right no-print">
          <button class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs"
            onclick="window.__deleteVacation('${emp.id}', ${idx})">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");
}
function renderThPayments(emp){
  const years = Object.keys(emp.thirteenthPayments || {}).sort((a,b)=> Number(a)-Number(b));
  if (!years.length){
    thTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhum 13¬∫ registrado.</td></tr>`;
    return;
  }
  thTable.innerHTML = years.map(y=>{
    const iso = emp.thirteenthPayments[y];
    const text = `13¬∫ do ano de ${y} foi pago na data ${formatISOToBR(iso)}`;
    return `
      <tr class="border-b last:border-b-0">
        <td class="py-2">${escapeHTML(text)}</td>
        <td class="py-2 text-right no-print">
          <button class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs"
            onclick="window.__deleteTh('${emp.id}', '${y}')">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");
}
function renderBuyVac(emp){
  const list = (emp.boughtVacations || []).slice().sort();
  if (!list.length){
    buyVacTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhuma compra de f√©rias registrada.</td></tr>`;
    return;
  }
  buyVacTable.innerHTML = list.map((iso,idx)=>{
    const text = `Comprei as f√©rias na data ${formatISOToBR(iso)}`;
    return `
      <tr class="border-b last:border-b-0">
        <td class="py-2">${escapeHTML(text)}</td>
        <td class="py-2 text-right no-print">
          <button class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs"
            onclick="window.__deleteBuyVac('${emp.id}', ${idx})">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");
}

/* ========= Editor open/new ========= */
window.__openEmpEditor = (id) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, id);
  if (!emp) return;
  ensureEmpShape(emp);

  editingEmpId = id;
  empEditorTitle.textContent = "Editar funcion√°rio";
  empEditorWrap.classList.remove("hidden");

  empName.value = emp.name || "";
  empAdmission.value = formatISOToBR(emp.admissionDate) || "";
  empSalary.value = currentSalary(emp) || 1650;
  empLoan.value = safeNum(emp.loanBalance) || 0;

  empActive.checked = (emp.status !== "dismissed");
  empDismissal.value = formatISOToBR(emp.dismissalDate) || "";

  // defaults dos inputs de pagamento (sugest√µes)
  pay2Date.value = "";
  pay2Type.value = "PAG20";
  pay2Gross.value = 650;
  pay2AlsoDiscountOn20.checked = false;

  ledDate.value = ""; ledDesc.value = ""; ledAmount.value = "";

  vacStart.value = ""; vacEnd.value = ""; vacPaidValue.value = "";
  thYear.value = ""; thDate.value = "";
  buyVacDate.value = "";

  renderSalaryHistory(emp);
  renderPayments(emp);
  renderLedger(emp);
  renderVacations(emp);
  renderThPayments(emp);
  renderBuyVac(emp);

  renderCalcEmployees();
};

function openNewEmp(){
  editingEmpId = null;
  empEditorTitle.textContent = "Novo funcion√°rio";
  empEditorWrap.classList.remove("hidden");

  empName.value = "";
  empAdmission.value = "";
  empSalary.value = 1650;
  empLoan.value = 0;

  empActive.checked = true;
  empDismissal.value = "";

  pay2Date.value = "";
  pay2Type.value = "PAG20";
  pay2Gross.value = 650;
  pay2AlsoDiscountOn20.checked = false;

  ledDate.value = ""; ledDesc.value = ""; ledAmount.value = "";

  vacStart.value = ""; vacEnd.value = ""; vacPaidValue.value = "";
  thYear.value = ""; thDate.value = "";
  buyVacDate.value = "";

  salaryHistoryTable.innerHTML = "";
  paymentsTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhum pagamento registrado.</td></tr>`;
  ledgerTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhum item no caderno.</td></tr>`;
  vacationsTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhuma f√©rias registrada.</td></tr>`;
  thTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhum 13¬∫ registrado.</td></tr>`;
  buyVacTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhuma compra de f√©rias registrada.</td></tr>`;
}

function saveLocalAndPush(emp){
  const ctx = getStoreCtx();
  upsertEmp(ctx.store, emp);
  ctx.db.stores[ctx.storeKey] = ctx.store;
  saveDB(ctx.db);
  renderEmployees();
  renderCalcEmployees();
  schedulePushEmp(emp);
}

/* ========= CRUD ========= */
function saveEmp(){
  const ctx = getStoreCtx();
  const store = ctx.store;

  const name = (empName.value || "").trim();
  const admissionISO = parseBRToISO(empAdmission.value);
  const salary = safeNum(empSalary.value);
  const loanBalance = safeNum(empLoan.value);

  if (!name) return alert("Informe o nome.");
  if (!admissionISO) return alert("Data de entrada inv√°lida. Use DD/MM/AAAA.");
  if (salary <= 0) return alert("Informe um sal√°rio v√°lido.");

  let emp = null;
  if (editingEmpId) emp = getEmpById(store, editingEmpId);
  if (!emp) {
    emp = { id: uid(), name:"", admissionDate:"", salaryHistory:[], ledger:[], payments:[], vacations:[],
      thirteenthPayments:{}, boughtVacations:[], loanBalance:0, status:"active", dismissalDate:"", updatedAt:0 };
  }
  ensureEmpShape(emp);

  emp.name = name;
  emp.admissionDate = admissionISO;
  emp.loanBalance = loanBalance;

  if (!empActive.checked) {
    emp.status = "dismissed";
    const disISO = empDismissal.value ? parseBRToISO(empDismissal.value) : null;
    emp.dismissalDate = disISO || todayISO();
  } else {
    emp.status = "active";
    emp.dismissalDate = "";
  }

  // grava sal√°rio (hist√≥rico)
  const effectiveDate = todayISO();
  const existingToday = emp.salaryHistory.find(h => h.date === effectiveDate);
  if (existingToday) existingToday.salary = salary;
  else emp.salaryHistory.push({ date: effectiveDate, salary });

  emp.updatedAt = Date.now();

  upsertEmp(store, emp);
  ctx.db.stores[ctx.storeKey] = store;
  saveDB(ctx.db);

  schedulePushEmp(emp);

  editingEmpId = emp.id;
  renderEmployees();
  window.__openEmpEditor(emp.id);
  alert("Salvo.");
}

function addSalaryChange(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const newSalary = safeNum(prompt("Novo sal√°rio (R$):", String(currentSalary(emp) || 1650)));
  if (!newSalary || newSalary <= 0) return;

  const br = prompt("Data efetiva (DD/MM/AAAA):", formatISOToBR(todayISO()));
  const iso = parseBRToISO(br);
  if (!iso) return alert("Data inv√°lida.");

  emp.salaryHistory.push({ date: iso, salary: newSalary });
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);
  window.__openEmpEditor(emp.id);
}

function archiveEmp(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  emp.status = "dismissed";
  emp.dismissalDate = emp.dismissalDate || todayISO();
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);
  alert("Arquivado como demitido.");
}

function deleteEmp(){
  const ctx = getStoreCtx();
  if (!editingEmpId) return alert("Abra um funcion√°rio.");
  const emp = getEmpById(ctx.store, editingEmpId);
  if (!emp) return;

  const ok = confirm(`Excluir "${emp.name}"? (Remove em todos os dispositivos)`);
  if (!ok) return;

  ctx.store.employees = (ctx.store.employees || []).filter(e=>e.id !== editingEmpId);
  ctx.db.stores[ctx.storeKey] = ctx.store;
  saveDB(ctx.db);

  pushDeleteEmp(editingEmpId);

  editingEmpId = null;
  empEditorWrap.classList.add("hidden");
  renderEmployees();
}

/* ========= Ledger/Pagamentos actions ========= */
function addLedger(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const dateISO = parseBRToISO(ledDate.value);
  if (!dateISO) return alert("Data inv√°lida (DD/MM/AAAA).");

  const desc = (ledDesc.value || "").trim();
  if (!desc) return alert("Informe a descri√ß√£o.");

  const amount = safeNum(ledAmount.value);
  if (amount <= 0) return alert("Valor inv√°lido.");

  addLedgerItem(emp, dateISO, desc, amount);
  saveLocalAndPush(emp);

  ledDate.value=""; ledDesc.value=""; ledAmount.value="";
  window.__openEmpEditor(emp.id);
}
window.__deleteLedger = (empId, idx) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, empId);
  if (!emp) return;
  const item = emp.ledger?.[idx];
  if (!item) return;

  if (item.status !== "pending") return alert("S√≥ √© poss√≠vel excluir itens pendentes.");
  const ok = confirm("Excluir este item do caderno?");
  if (!ok) return;

  emp.ledger.splice(idx,1);
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);
  window.__openEmpEditor(emp.id);
};
window.__undoLedger = (empId, idx) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, empId);
  if (!emp) return;
  const item = emp.ledger?.[idx];
  if (!item) return;

  const ok = confirm("Voltar este item para PENDENTE? (n√£o apaga pagamento registrado)");
  if (!ok) return;

  item.status = "pending";
  item.deductedOnPaymentId = null;
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);
  window.__openEmpEditor(emp.id);
};

function autoSuggestGrossByType(){
  const t = pay2Type.value;
  pay2Gross.value = (t==="PAG05") ? 1000 : 650;
}
function registerPay(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const payDateISO = parseBRToISO(pay2Date.value);
  if (!payDateISO) return alert("Data do pagamento inv√°lida (DD/MM/AAAA).");

  const type = pay2Type.value;
  if (!["PAG20","PAG05"].includes(type)) return alert("Tipo inv√°lido.");

  const gross = safeNum(pay2Gross.value);
  if (gross <= 0) return alert("Valor bruto inv√°lido.");

  const alsoOn20 = pay2AlsoDiscountOn20.checked;

  registerPayment(emp, type, payDateISO, gross, alsoOn20);
  saveLocalAndPush(emp);

  pay2Date.value = "";
  pay2AlsoDiscountOn20.checked = false;
  autoSuggestGrossByType();
  window.__openEmpEditor(emp.id);
}
window.__deletePayment = (empId, idx) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, empId);
  if (!emp) return;
  const ok = confirm("Excluir este pagamento? (n√£o reverte descontos automaticamente)");
  if (!ok) return;

  emp.payments.splice(idx,1);
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);
  window.__openEmpEditor(emp.id);
};

/* ========= F√©rias / 13¬∫ / compra ========= */
function addVacationPeriod(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const sISO = parseBRToISO(vacStart.value);
  const eISO = parseBRToISO(vacEnd.value);
  if (!sISO) return alert("In√≠cio inv√°lido.");
  if (!eISO) return alert("Fim inv√°lido.");
  if (eISO < sISO) return alert("Fim n√£o pode ser menor que in√≠cio.");

  const paid = safeNum(vacPaidValue.value);
  if (paid <= 0) return alert("Valor pago inv√°lido.");

  emp.vacations.push({ id: uid(), startISO: sISO, endISO: eISO, paidValue: paid });
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);

  vacStart.value=""; vacEnd.value=""; vacPaidValue.value="";
  window.__openEmpEditor(emp.id);
}
window.__deleteVacation = (empId, idx) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, empId);
  if (!emp) return;
  const ok = confirm("Excluir esta f√©rias?");
  if (!ok) return;
  emp.vacations.splice(idx, 1);
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);
  window.__openEmpEditor(emp.id);
};

function addThPayment(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const year = Number(thYear.value);
  if (!year || year < 2000 || year > 2100) return alert("Ano inv√°lido.");

  const iso = parseBRToISO(thDate.value);
  if (!iso) return alert("Data inv√°lida.");

  emp.thirteenthPayments[String(year)] = iso;
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);

  thYear.value=""; thDate.value="";
  window.__openEmpEditor(emp.id);
}
window.__deleteTh = (empId, year) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, empId);
  if (!emp) return;
  const ok = confirm(`Excluir o 13¬∫ do ano ${year}?`);
  if (!ok) return;
  delete emp.thirteenthPayments[year];
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);
  window.__openEmpEditor(emp.id);
};

function addBuyVac(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const iso = parseBRToISO(buyVacDate.value);
  if (!iso) return alert("Data inv√°lida.");

  emp.boughtVacations.push(iso);
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);

  buyVacDate.value="";
  window.__openEmpEditor(emp.id);
}
window.__deleteBuyVac = (empId, idx) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, empId);
  if (!emp) return;
  const ok = confirm("Excluir esta compra de f√©rias?");
  if (!ok) return;
  emp.boughtVacations.splice(idx, 1);
  emp.updatedAt = Date.now();
  saveLocalAndPush(emp);
  window.__openEmpEditor(emp.id);
};

/* ========= Rescis√£o (simples) ========= */
function calcINSSSimple(base){ base = Math.max(0, base); return Math.min(base * 0.11, 900); }
function monthsFor13th(terminationISO){
  if (!terminationISO) return 0;
  const d = new Date(terminationISO + "T00:00:00");
  const m = d.getMonth() + 1;
  const day = d.getDate();
  return (m - 1) + (day >= 15 ? 1 : 0);
}
function labelType(t){
  if (t==="sem_justa_causa") return "Sem justa causa";
  if (t==="pedido_demissao") return "Pedido de demiss√£o";
  if (t==="acordo") return "Acordo";
  return t;
}
function line(label, value){
  return `
    <div class="flex items-center justify-between gap-3">
      <div class="text-sm text-slate-600">${escapeHTML(label)}</div>
      <div class="text-sm font-semibold">${formatBRL(value)}</div>
    </div>
  `;
}
function renderCalcEmployees(){
  const ctx = getStoreCtx();
  if (!ctx) return;
  const emps = (ctx.store.employees || []).filter(e => (e.status || "active") !== "dismissed");
  calcEmp.innerHTML = emps.map(e=>`<option value="${e.id}">${escapeHTML(e.name)}</option>`).join("");
  calcDate.value = calcDate.value || todayISO();
  const selected = getEmpById(ctx.store, calcEmp.value);
  if (selected) calcLoanDiscount.value = safeNum(selected.loanBalance);
}
function doCalc(){
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, calcEmp.value);
  if (!emp) return alert("Selecione um funcion√°rio.");

  const term = calcDate.value;
  if (!term) return alert("Informe a data de desligamento.");

  const salary = currentSalary(emp);
  const daysWorked = Math.max(0, Math.min(31, Number(calcDaysWorked.value||0)));
  const vacMonths = Math.max(0, Math.min(12, Number(calcVacMonths.value||0)));
  const vacOverdue = Math.max(0, Math.min(3, Number(calcVacOverdue.value||0)));
  const noticeDaysRaw = Math.max(0, Math.min(120, Number(calcNoticeDays.value||0)));
  const fgtsBal = safeNum(calcFgtsBalance.value);
  const loanDisc = safeNum(calcLoanDiscount.value);

  const type = calcType.value;
  const daily = salary / 30;

  const saldoSalario = daily * daysWorked;
  const m13 = monthsFor13th(term);
  const decimoTerceiro = (salary / 12) * m13;

  const feriasProp = (salary / 12) * vacMonths;
  const feriasVencidas = salary * vacOverdue;
  const feriasTotal = feriasProp + feriasVencidas;
  const umTerco = feriasTotal / 3;

  let noticeDays = noticeDaysRaw;
  if (type === "pedido_demissao") noticeDays = 0;
  if (type === "acordo") noticeDays = noticeDaysRaw / 2;
  const avisoPrevio = daily * noticeDays;

  let fgtsRate = 0.40;
  if (type === "acordo") fgtsRate = 0.20;
  if (type === "pedido_demissao") fgtsRate = 0.00;
  const multaFgts = (document.getElementById("optFgts").checked ? fgtsBal * fgtsRate : 0);

  const baseInss = saldoSalario + avisoPrevio + decimoTerceiro;
  const inss = (document.getElementById("optInss").checked ? calcINSSSimple(baseInss) : 0);

  const bruto = saldoSalario + decimoTerceiro + feriasTotal + umTerco + avisoPrevio + multaFgts;
  const descontos = inss + loanDisc;
  const liquido = bruto - descontos;

  calcResult.innerHTML = `
    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
      <div class="text-sm text-slate-500">Resumo</div>
      <div class="text-lg font-bold mt-1">${escapeHTML(emp.name)} ‚Ä¢ ${escapeHTML(ctx.store.name)}</div>
      <div class="text-sm text-slate-600">Desligamento: <span class="font-semibold">${term}</span> ‚Ä¢ Tipo: <span class="font-semibold">${escapeHTML(labelType(type))}</span></div>

      <div class="mt-4 grid md:grid-cols-2 gap-3">
        <div class="bg-white border border-slate-200 rounded-2xl p-3">
          <div class="font-semibold">Proventos</div>
          <div class="mt-2 space-y-1">
            ${line("Saldo de sal√°rio", saldoSalario)}
            ${line(`13¬∫ proporcional (${m13}/12)`, decimoTerceiro)}
            ${line(`F√©rias proporcionais (${vacMonths}/12)`, feriasProp)}
            ${line(`F√©rias vencidas (${vacOverdue} per√≠odo)`, feriasVencidas)}
            ${line("1/3 constitucional", umTerco)}
            ${line(`Aviso pr√©vio (${noticeDays.toFixed(0)} dias)`, avisoPrevio)}
            ${line(`Multa FGTS (${(fgtsRate*100).toFixed(0)}%)`, multaFgts)}
          </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-2xl p-3">
          <div class="font-semibold">Descontos</div>
          <div class="mt-2 space-y-1">
            ${line("INSS", inss)}
            ${line("Desconto empr√©stimo", loanDisc)}
          </div>

          <div class="mt-4 border-t border-slate-200 pt-3">
            <div class="flex items-center justify-between">
              <div class="text-sm text-slate-600">Total bruto</div>
              <div class="font-bold">${formatBRL(bruto)}</div>
            </div>
            <div class="flex items-center justify-between mt-1">
              <div class="text-sm text-slate-600">Total descontos</div>
              <div class="font-bold">${formatBRL(descontos)}</div>
            </div>
            <div class="flex items-center justify-between mt-2">
              <div class="text-base font-semibold">Total l√≠quido</div>
              <div class="text-base font-bold">${formatBRL(liquido)}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="text-xs text-slate-500 mt-3">C√°lculo simples e ajust√°vel (modelo pr√°tico).</div>
    </div>
  `;
  return { emp, term, type };
}
function exportPDF(){
  const r = doCalc();
  if (!r) return;
  const ctx = getStoreCtx();
  const win = window.open("", "_blank");
  win.document.open();
  win.document.write(`
    <!doctype html><html lang="pt-BR"><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rescis√£o - ${escapeHTML(r.emp.name)}</title>
    <style>body{font-family:Arial,sans-serif;padding:18px}</style>
    </head><body>
      <h2>Rescis√£o (simples)</h2>
      <div style="color:#666;font-size:12px">
        Loja: <b>${escapeHTML(ctx.store.name)}</b> ‚Ä¢ Funcion√°rio: <b>${escapeHTML(r.emp.name)}</b><br>
        Data: <b>${escapeHTML(r.term)}</b> ‚Ä¢ Tipo: <b>${escapeHTML(labelType(r.type))}</b>
      </div>
      <div style="height:12px"></div>
      ${calcResult.innerHTML}
    </body></html>
  `);
  win.document.close();
  win.onload = () => win.print();
}

/* ========= PIN Settings ========= */
async function changePin(){
  const ctx = getStoreCtx();
  const userKey = ctx.session.userKey;
  const mgr = ctx.store.managers[userKey];

  const oldPin = (pinOld.value || "").trim();
  const newPin = (pinNew.value || "").trim();
  if (newPin.length < 4) return alert("Novo PIN muito curto (m√≠nimo 4).");
  if (!oldPin) return alert("Informe o PIN atual.");

  const oldHash = await hashPin(oldPin);
  if (oldHash !== mgr.pinHash) return alert("PIN atual incorreto.");

  mgr.pinHash = await hashPin(newPin);
  ctx.db.stores[ctx.storeKey] = ctx.store;
  saveDB(ctx.db);

  pinOld.value = ""; pinNew.value = "";
  alert("PIN alterado.");
}

/* ========= Backup local ========= */
function exportJSON(){
  const ctx = getStoreCtx();
  const payload = { storeKey: ctx.storeKey, exportedAt: new Date().toISOString(), store: ctx.store };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backup_${ctx.storeKey}_${todayISO()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function importJSON(file){
  const ctx = getStoreCtx();
  const fr = new FileReader();
  fr.onload = () => {
    try {
      const parsed = JSON.parse(fr.result);
      if (!parsed || !parsed.store) return alert("JSON inv√°lido.");
      ctx.db.stores[ctx.storeKey].employees = parsed.store.employees || [];
      // garante shape
      ctx.db.stores[ctx.storeKey].employees.forEach(ensureEmpShape);
      saveDB(ctx.db);
      renderEmployees();
      alert("Importado.");
    } catch {
      alert("Falha ao ler JSON.");
    }
  };
  fr.readAsText(file);
}
function resetStore(){
  const ok = confirm("Resetar dados desta loja?");
  if (!ok) return;
  const ctx = getStoreCtx();
  ctx.db.stores[ctx.storeKey].employees = [];
  saveDB(ctx.db);
  renderEmployees();
  alert("Loja resetada.");
}

/* ========= Firebase Auth (Email/Senha) ========= */
async function fbSignIn(){
  initFirebaseOnce();
  const email = (fbEmail.value || "").trim();
  const pass = (fbPass.value || "").trim();
  if (!email || !pass) return alert("Informe email e senha.");

  try {
    await signInWithEmailAndPassword(fb.auth, email, pass);
  } catch (e) {
    if (String(e?.code||"").includes("auth/user-not-found")) {
      await createUserWithEmailAndPassword(fb.auth, email, pass);
      return;
    }
    console.error(e);
    alert("Falha ao conectar Firebase. Veja o console.");
  }
}
async function fbSignOut(){
  initFirebaseOnce();
  await signOut(fb.auth);
}

/* ========= Login por PIN ========= */
document.getElementById("btnLogin").addEventListener("click", async () => {
  const user = document.getElementById("loginUser").value;
  const pin = (document.getElementById("loginPin").value || "").trim();
  if (!pin) return alert("Informe o PIN.");

  await ensureDefaultPins();
  const storeKey = resolveStoreFromUser(user);
  const db = loadDB();
  const mgr = db.stores[storeKey].managers[user];

  const pinHash = await hashPin(pin);
  if (pinHash !== mgr.pinHash) return alert("PIN incorreto.");

  setSession({ userKey: user, storeKey });
  document.getElementById("loginPin").value = "";
  requireAuth();
});

/* ========= UI events ========= */
btnLogout.addEventListener("click", () => { clearSession(); requireAuth(); });
tabBtns.forEach(b => b.addEventListener("click", ()=> openTab(b.dataset.tab)));

empSearch.addEventListener("input", renderEmployees);
empSort.addEventListener("change", renderEmployees);
btnNewEmp.addEventListener("click", openNewEmp);
btnCloseEmpEditor.addEventListener("click", ()=> empEditorWrap.classList.add("hidden"));
btnToggleDismissed.addEventListener("click", ()=>{ showDismissed = !showDismissed; renderEmployees(); });

btnSaveEmp.addEventListener("click", saveEmp);
btnAddSalaryChange.addEventListener("click", addSalaryChange);
btnArchiveEmp.addEventListener("click", archiveEmp);
btnDeleteEmp.addEventListener("click", deleteEmp);

btnRegisterPay.addEventListener("click", registerPay);
pay2Type.addEventListener("change", autoSuggestGrossByType);

btnAddLedger.addEventListener("click", addLedger);

btnAddVacation.addEventListener("click", addVacationPeriod);
btnAddTh.addEventListener("click", addThPayment);
btnAddBuyVac.addEventListener("click", addBuyVac);

empAdmission.addEventListener("blur", ()=> normalizeBRDateInput(empAdmission));
empDismissal.addEventListener("blur", ()=> { if (empDismissal.value.trim()) normalizeBRDateInput(empDismissal); });

pay2Date.addEventListener("blur", ()=> { if (pay2Date.value.trim()) normalizeBRDateInput(pay2Date); });
ledDate.addEventListener("blur", ()=> { if (ledDate.value.trim()) normalizeBRDateInput(ledDate); });

vacStart.addEventListener("blur", ()=> { if (vacStart.value.trim()) normalizeBRDateInput(vacStart); });
vacEnd.addEventListener("blur", ()=> { if (vacEnd.value.trim()) normalizeBRDateInput(vacEnd); });
thDate.addEventListener("blur", ()=> { if (thDate.value.trim()) normalizeBRDateInput(thDate); });
buyVacDate.addEventListener("blur", ()=> { if (buyVacDate.value.trim()) normalizeBRDateInput(buyVacDate); });

calcEmp.addEventListener("change", ()=>{
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, calcEmp.value);
  if (emp) calcLoanDiscount.value = safeNum(emp.loanBalance);
});
btnCalc.addEventListener("click", doCalc);
btnPdf.addEventListener("click", exportPDF);

btnChangePin.addEventListener("click", changePin);
btnExport.addEventListener("click", exportJSON);
fileImport.addEventListener("change", (e)=>{
  const f = e.target.files?.[0];
  if (f) importJSON(f);
  e.target.value = "";
});
btnReset.addEventListener("click", resetStore);

btnFbSignIn.addEventListener("click", fbSignIn);
btnFbSignOut.addEventListener("click", fbSignOut);

/* Boot */
(async function boot(){
  initFirebaseOnce();
  setFbStatus("Firebase: desconectado");
  await ensureDefaultPins();

  // garante migra√ß√£o/shape em todos os funcion√°rios locais
  const s = getSession();
  if (s){
    const ctx = getStoreCtx();
    (ctx.store.employees||[]).forEach(ensureEmpShape);
    ctx.db.stores[ctx.storeKey] = ctx.store;
    saveDB(ctx.db);
  }

  requireAuth();
  calcDate.value = todayISO();
})();
</script>
</body>
</html>
