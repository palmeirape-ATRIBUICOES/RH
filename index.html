<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>RH Simples - 2 Lojas</title>

  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @media print { .no-print { display:none !important; } body { background:#fff !important; } }
    .help { font-size: 12px; color: rgb(100 116 139); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
    <div class="min-w-0">
      <div class="font-bold truncate">RH Simples</div>
      <div class="text-xs text-slate-500" id="hdrSub">Offline (localStorage) ‚Ä¢ Firebase opcional</div>
    </div>

    <div class="flex items-center gap-2">
      <button id="btnInstall" class="hidden no-print px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">Instalar</button>
      <button id="btnLogout" class="hidden no-print px-3 py-2 rounded-xl border border-slate-300 text-sm">Sair</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-5">
  <!-- LOGIN -->
  <section id="viewLogin" class="max-w-lg mx-auto">
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
      <h1 class="text-xl font-bold">Entrar</h1>
      <p class="text-sm text-slate-600 mt-1">
        Cada gerente acessa apenas sua loja:
        <span class="font-semibold">MANA DE DEUS (Mana Thiago)</span> e
        <span class="font-semibold">BOGADOS PADARIA (Ellen)</span>.
      </p>

      <div class="mt-4 grid gap-3">
        <label class="text-sm">
          <span class="block text-slate-600 mb-1">Perfil</span>
          <select id="loginUser" class="w-full rounded-xl border border-slate-300 px-3 py-2">
            <option value="mana_thiago">Mana Thiago (MANA DE DEUS)</option>
            <option value="bogados_ellen">Ellen (BOGADOS PADARIA)</option>
          </select>
        </label>

        <label class="text-sm">
          <span class="block text-slate-600 mb-1">PIN</span>
          <input id="loginPin" type="password" inputmode="numeric"
                 class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Ex.: 1234" />
        </label>

        <button id="btnLogin" class="mt-1 w-full rounded-xl bg-slate-900 text-white px-4 py-2 font-semibold">
          Entrar
        </button>

        <div class="text-xs text-slate-500">
          Primeiro uso (padr√£o): <span class="font-semibold">Mana Thiago = 1234</span> ‚Ä¢
          <span class="font-semibold">Ellen = 4321</span>.
        </div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="viewApp" class="hidden">
    <div class="grid lg:grid-cols-12 gap-4">
      <!-- Sidebar -->
      <aside class="lg:col-span-3">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
          <div class="text-sm text-slate-500">Logado como</div>
          <div class="font-bold" id="whoami">‚Äî</div>
          <div class="text-sm mt-1">
            Loja: <span class="font-semibold" id="storeName">‚Äî</span>
          </div>

          <div class="mt-4 grid gap-2 no-print">
            <button class="tabBtn px-3 py-2 rounded-xl border border-slate-300 text-sm text-left" data-tab="employees">üë• Funcion√°rios</button>
            <button class="tabBtn px-3 py-2 rounded-xl border border-slate-300 text-sm text-left" data-tab="calc">üßÆ Rescis√£o</button>
            <button class="tabBtn px-3 py-2 rounded-xl border border-slate-300 text-sm text-left" data-tab="settings">‚öôÔ∏è Config</button>
          </div>
        </div>

        <div class="mt-4 bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
          <div class="text-sm font-semibold">Sincroniza√ß√£o</div>
          <div class="text-sm text-slate-600 mt-1">
            Voc√™ pode usar s√≥ offline ou ativar Firebase.
          </div>
          <div class="mt-3 flex flex-wrap gap-2 no-print">
            <button id="btnFbConnect" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">Conectar Firebase</button>
            <button id="btnFbSyncDown" class="px-3 py-2 rounded-xl border border-slate-300 text-sm">Baixar</button>
            <button id="btnFbSyncUp" class="px-3 py-2 rounded-xl border border-slate-300 text-sm">Enviar</button>
          </div>
          <div class="mt-2 text-xs text-slate-500" id="fbStatus">Firebase: desconectado</div>
        </div>
      </aside>

      <!-- Content -->
      <section class="lg:col-span-9">
        <!-- Funcion√°rios -->
        <div id="tab_employees" class="tabPanel">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <div class="flex flex-col md:flex-row md:items-center gap-3 md:justify-between">
              <div>
                <h2 class="text-xl font-bold">Funcion√°rios</h2>
                <p class="text-sm text-slate-600">
                  Clique no funcion√°rio para abrir o <b>drop-down</b> com todos os lan√ßamentos (sal√°rios recebidos, f√©rias, 13¬∫ e compra de f√©rias).
                </p>
              </div>
              <div class="flex gap-2 no-print">
                <button id="btnNewEmp" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">+ Novo</button>
                <button id="btnToggleDismissed" class="px-3 py-2 rounded-xl border border-slate-300 text-sm">Ver demitidos</button>
              </div>
            </div>

            <div class="mt-4 grid md:grid-cols-3 gap-3 no-print">
              <input id="empSearch" class="md:col-span-2 w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Buscar por nome..." />
              <select id="empSort" class="w-full rounded-xl border border-slate-300 px-3 py-2">
                <option value="name">Ordenar: Nome</option>
                <option value="admission">Ordenar: Data de entrada</option>
              </select>
            </div>

            <div class="mt-4 overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-slate-500">
                <tr class="border-b">
                  <th class="text-left py-2">Funcion√°rio</th>
                  <th class="text-left py-2">Entrada</th>
                  <th class="text-left py-2">Sal√°rio atual</th>
                  <th class="text-left py-2">Empr√©stimo</th>
                  <th class="text-right py-2 no-print">A√ß√µes</th>
                </tr>
                </thead>
                <tbody id="empTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Editor -->
          <div id="empEditorWrap" class="hidden mt-4 bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h3 class="text-lg font-bold" id="empEditorTitle">Novo funcion√°rio</h3>
                <p class="text-sm text-slate-600">Editor completo (lan√ßamentos ficam no drop-down da lista tamb√©m).</p>
              </div>
              <button id="btnCloseEmpEditor" class="no-print px-3 py-2 rounded-xl border border-slate-300 text-sm">Fechar</button>
            </div>

            <div class="mt-4 grid md:grid-cols-2 gap-3">
              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Nome</span>
                <input id="empName" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Nome do funcion√°rio" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Data de entrada (DD/MM/AAAA)</span>
                <input id="empAdmission" inputmode="numeric"
                       class="w-full rounded-xl border border-slate-300 px-3 py-2"
                       placeholder="17/01/2024" />
                <div class="help mt-1">Ex.: 17/01/2024</div>
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Sal√°rio atual (R$)</span>
                <input id="empSalary" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Ex.: 1800" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Empr√©stimo atual (R$)</span>
                <input id="empLoan" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Ex.: 200" />
              </label>
            </div>

            <!-- SAL√ÅRIO RECEBIDO (M√äS A M√äS) -->
            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
              <div class="text-sm font-semibold">Sal√°rio recebido (m√™s a m√™s)</div>
              <div class="text-sm text-slate-600">Ex.: Sal√°rio recebido no m√™s 01/2026 na data 05/01/2026 (R$ ...)</div>

              <div class="mt-3 grid md:grid-cols-5 gap-3 no-print">
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Ano</span>
                  <input id="payYear" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="2026" />
                </label>
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">M√™s (1-12)</span>
                  <input id="payMonth" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="1" />
                </label>
                <label class="text-sm md:col-span-2">
                  <span class="block text-slate-600 mb-1">Data do pagamento</span>
                  <input id="payDate" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="05/01/2026" />
                </label>
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Valor (R$)</span>
                  <input id="payAmount" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="1800" />
                </label>
                <button id="btnAddPay" class="md:col-span-5 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">
                  + Registrar sal√°rio recebido
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Texto</th>
                    <th class="text-right py-2 no-print">A√ß√µes</th>
                  </tr>
                  </thead>
                  <tbody id="payTable"></tbody>
                </table>
              </div>
            </div>

            <!-- F√âRIAS (PER√çODOS) => DROPDOWN MOSTRA "Tirou f√©rias na data ..." -->
            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
              <div class="text-sm font-semibold">F√©rias (per√≠odos)</div>
              <div class="text-sm text-slate-600">No drop-down da lista vai aparecer: <b>Tirou f√©rias na data (in√≠cio)</b>.</div>

              <div class="mt-3 grid md:grid-cols-4 gap-3 no-print">
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">In√≠cio</span>
                  <input id="vacStart" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="15/01/2024" />
                </label>
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Fim</span>
                  <input id="vacEnd" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="14/02/2024" />
                </label>
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Valor pago (R$)</span>
                  <input id="vacPaidValue" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Ex.: 2500" />
                </label>
                <button id="btnAddVacation" class="mt-6 md:mt-0 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">
                  + Adicionar f√©rias
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Texto</th>
                    <th class="text-right py-2 no-print">A√ß√µes</th>
                  </tr>
                  </thead>
                  <tbody id="vacationsTable"></tbody>
                </table>
              </div>
            </div>

            <!-- 13¬∫ (ANO + DATA) -->
            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
              <div class="text-sm font-semibold">13¬∫ sal√°rio (ano + data)</div>
              <div class="text-sm text-slate-600">Ex.: 13¬∫ do ano de 2024 foi pago na data 20/12/2024.</div>

              <div class="mt-3 grid md:grid-cols-3 gap-3 no-print">
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Ano</span>
                  <input id="thYear" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="2024" />
                </label>
                <label class="text-sm">
                  <span class="block text-slate-600 mb-1">Data do pagamento</span>
                  <input id="thDate" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="20/12/2024" />
                </label>
                <button id="btnAddTh" class="mt-6 md:mt-0 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">
                  + Registrar 13¬∫
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Texto</th>
                    <th class="text-right py-2 no-print">A√ß√µes</th>
                  </tr>
                  </thead>
                  <tbody id="thTable"></tbody>
                </table>
              </div>
            </div>

            <!-- COMPRA DE F√âRIAS (DATA) -->
            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
              <div class="text-sm font-semibold">Compra de f√©rias (data)</div>
              <div class="text-sm text-slate-600">Ex.: Comprei as f√©rias na data 10/01/2025.</div>

              <div class="mt-3 grid md:grid-cols-3 gap-3 no-print">
                <label class="text-sm md:col-span-2">
                  <span class="block text-slate-600 mb-1">Data</span>
                  <input id="buyVacDate" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="10/01/2025" />
                </label>
                <button id="btnAddBuyVac" class="mt-6 md:mt-0 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">
                  + Registrar compra
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Texto</th>
                    <th class="text-right py-2 no-print">A√ß√µes</th>
                  </tr>
                  </thead>
                  <tbody id="buyVacTable"></tbody>
                </table>
              </div>
            </div>

            <!-- STATUS -->
            <div class="mt-4 text-sm">
              <div class="text-slate-600">Status</div>
              <div class="flex flex-wrap items-center gap-3 mt-1">
                <label class="inline-flex items-center gap-2">
                  <input id="empActive" type="checkbox" class="h-4 w-4" checked />
                  <span>Ativo</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <span class="text-slate-600">Data de demiss√£o (DD/MM/AAAA)</span>
                  <input id="empDismissal" inputmode="numeric" class="rounded-xl border border-slate-300 px-3 py-2" placeholder="10/02/2026" />
                </label>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2 no-print">
              <button id="btnSaveEmp" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">Salvar</button>
              <button id="btnAddSalaryChange" class="px-4 py-2 rounded-xl border border-slate-300">Registrar mudan√ßa de sal√°rio</button>
              <button id="btnArchiveEmp" class="px-4 py-2 rounded-xl border border-amber-300 text-amber-700">Arquivar (demitido)</button>
              <button id="btnDeleteEmp" class="px-4 py-2 rounded-xl border border-rose-300 text-rose-700">Excluir</button>
            </div>

            <div class="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-3">
              <div class="text-sm font-semibold">Hist√≥rico de sal√°rio (altera√ß√µes)</div>
              <div class="mt-2 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-slate-500">
                  <tr class="border-b">
                    <th class="text-left py-2">Data</th>
                    <th class="text-left py-2">Sal√°rio (R$)</th>
                  </tr>
                  </thead>
                  <tbody id="salaryHistoryTable"></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>

        <!-- Rescis√£o -->
        <div id="tab_calc" class="tabPanel hidden">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <h2 class="text-xl font-bold">C√°lculo de Rescis√£o (simples)</h2>

            <div class="mt-4 grid md:grid-cols-3 gap-3 no-print">
              <label class="text-sm md:col-span-2">
                <span class="block text-slate-600 mb-1">Funcion√°rio</span>
                <select id="calcEmp" class="w-full rounded-xl border border-slate-300 px-3 py-2"></select>
              </label>
              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Data de desligamento</span>
                <input id="calcDate" type="date" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Tipo</span>
                <select id="calcType" class="w-full rounded-xl border border-slate-300 px-3 py-2">
                  <option value="sem_justa_causa">Sem justa causa</option>
                  <option value="pedido_demissao">Pedido de demiss√£o</option>
                  <option value="acordo">Acordo (metade aviso + 20% FGTS)</option>
                </select>
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Dias trabalhados no m√™s</span>
                <input id="calcDaysWorked" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="15" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Meses p/ f√©rias proporcionais (0‚Äì12)</span>
                <input id="calcVacMonths" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="0" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">F√©rias vencidas? (0 ou 1 per√≠odo)</span>
                <input id="calcVacOverdue" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="0" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Aviso pr√©vio indenizado (dias)</span>
                <input id="calcNoticeDays" type="number" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="30" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Saldo FGTS (R$) (para multa)</span>
                <input id="calcFgtsBalance" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="0" />
              </label>

              <label class="text-sm">
                <span class="block text-slate-600 mb-1">Desconto empr√©stimo (R$)</span>
                <input id="calcLoanDiscount" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2" value="0" />
              </label>
            </div>

            <div class="mt-4 flex flex-wrap gap-3 items-center no-print">
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="optInss" type="checkbox" class="h-4 w-4" checked />
                <span>Incluir INSS</span>
              </label>
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="optFgts" type="checkbox" class="h-4 w-4" checked />
                <span>Incluir multa FGTS</span>
              </label>

              <button id="btnCalc" class="ml-auto px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">Calcular</button>
              <button id="btnPdf" class="px-4 py-2 rounded-xl border border-slate-300">Exportar PDF</button>
            </div>

            <div class="mt-4 border-t border-slate-200 pt-4">
              <div id="calcResult" class="text-sm text-slate-700"></div>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div id="tab_settings" class="tabPanel hidden">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <h2 class="text-xl font-bold">Config</h2>

            <div class="mt-4 grid md:grid-cols-2 gap-3 no-print">
              <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                <div class="font-semibold">Trocar PIN</div>
                <label class="text-sm block mt-3">
                  <span class="block text-slate-600 mb-1">PIN atual</span>
                  <input id="pinOld" type="password" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </label>
                <label class="text-sm block mt-2">
                  <span class="block text-slate-600 mb-1">Novo PIN</span>
                  <input id="pinNew" type="password" inputmode="numeric" class="w-full rounded-xl border border-slate-300 px-3 py-2" />
                </label>
                <button id="btnChangePin" class="mt-3 px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold">Salvar PIN</button>
              </div>

              <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                <div class="font-semibold">Backup</div>
                <div class="text-sm text-slate-600 mt-1">Exporta/Importa JSON com os dados desta loja.</div>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button id="btnExport" class="px-4 py-2 rounded-xl border border-slate-300">Exportar JSON</button>
                  <label class="px-4 py-2 rounded-xl border border-slate-300 cursor-pointer">
                    Importar JSON
                    <input id="fileImport" type="file" accept="application/json" class="hidden" />
                  </label>
                  <button id="btnReset" class="px-4 py-2 rounded-xl border border-rose-300 text-rose-700">Reset loja</button>
                </div>
              </div>
            </div>

            <div class="mt-4 text-xs text-slate-500">
              Firebase Config j√° est√° no HTML. Ative Firestore + Auth An√¥nimo conforme instru√ß√µes abaixo.
            </div>
          </div>
        </div>

      </section>
    </div>
  </section>
</main>

<!-- Firebase + App JS -->
<script type="module">
/* =========================================================
   Firebase (CDN modular)
   Vers√£o 12.9.0 (CDN oficial) - conforme docs
   ========================================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, deleteDoc,
  collection, getDocs
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import {
  getAuth, signInAnonymously, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCN6TZYTw4wQlAVnsB7uJZtG8KsTTxKJ94",
  authDomain: "thrh-640ab.firebaseapp.com",
  projectId: "thrh-640ab",
  storageBucket: "thrh-640ab.firebasestorage.app",
  messagingSenderId: "1004522826863",
  appId: "1:1004522826863:web:0e3a8e6a0a053dfcdfb19a"
};

let fb = { app:null, db:null, auth:null, ready:false, user:null };

/* ========= PWA single-file (manifest via blob) ========= */
(function setupPWA(){
  try {
    const manifest = {
      name: "RH Simples",
      short_name: "RH",
      start_url: "./",
      display: "standalone",
      background_color: "#f8fafc",
      theme_color: "#0f172a"
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement("link");
    link.rel = "manifest";
    link.href = url;
    document.head.appendChild(link);
  } catch {}

  let deferredPrompt = null;
  const btnInstall = document.getElementById("btnInstall");
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    btnInstall.classList.remove("hidden");
  });
  btnInstall.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    deferredPrompt = null;
    btnInstall.classList.add("hidden");
  });
})();

/* ========= Storage / Helpers ========= */
const LS_KEY = "pwa_rh_simples_v4";
const SESSION_KEY = "pwa_rh_session_v1";

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function safeNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
function formatBRL(n){ return Number(n||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }
function escapeHTML(str){
  return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function todayISO(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

/* --- Datas DD/MM/AAAA <-> ISO --- */
function formatISOToBR(iso){
  if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return "";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}
function parseBRToISO(br){
  const s = String(br||"").trim();
  const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (!m) return null;
  const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
  if (yy < 1900 || yy > 2100) return null;
  if (mm < 1 || mm > 12) return null;
  if (dd < 1 || dd > 31) return null;
  const iso = `${yy}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
  const dt = new Date(iso + "T00:00:00");
  const ok = dt.getFullYear()===yy && (dt.getMonth()+1)===mm && dt.getDate()===dd;
  return ok ? iso : null;
}
function normalizeBRDateInput(el){
  const iso = parseBRToISO(el.value);
  if (!iso) return false;
  el.value = formatISOToBR(iso);
  return true;
}

/* --- Hash PIN com fallback --- */
async function hashPin(text){
  text = String(text ?? "");
  if (window.crypto && crypto.subtle && window.isSecureContext) {
    const enc = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,"0")).join("");
  }
  let h = 5381;
  for (let i = 0; i < text.length; i++) h = ((h << 5) + h) + text.charCodeAt(i);
  return "fb_" + (h >>> 0).toString(16);
}

/* ========= DB local ========= */
function defaultDB(){
  return {
    version: 4,
    stores: {
      mana: {
        name: "MANA DE DEUS",
        managers: { mana_thiago: { label: "Mana Thiago", pinHash: null } },
        employees: []
      },
      bogados: {
        name: "BOGADOS PADARIA",
        managers: { bogados_ellen: { label: "Ellen", pinHash: null } },
        employees: []
      }
    }
  };
}
function loadDB(){
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return defaultDB();
  try { return JSON.parse(raw); } catch { return defaultDB(); }
}
function saveDB(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

async function ensureDefaultPins(){
  const db = loadDB();
  const manaMgr = db.stores.mana.managers.mana_thiago;
  const bogMgr  = db.stores.bogados.managers.bogados_ellen;
  if (!manaMgr.pinHash) manaMgr.pinHash = await hashPin("1234");
  if (!bogMgr.pinHash)  bogMgr.pinHash  = await hashPin("4321");
  saveDB(db);
}

function setSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
function getSession(){
  const raw = localStorage.getItem(SESSION_KEY);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function clearSession(){ localStorage.removeItem(SESSION_KEY); }

function resolveStoreFromUser(user){
  if (user === "mana_thiago") return "mana";
  if (user === "bogados_ellen") return "bogados";
  return null;
}
function getStoreCtx(){
  const s = getSession();
  if (!s) return null;
  const db = loadDB();
  return { session: s, db, storeKey: s.storeKey, store: db.stores[s.storeKey] };
}

/* ========= Firebase helpers ========= */
const fbStatus = document.getElementById("fbStatus");
const btnFbConnect = document.getElementById("btnFbConnect");
const btnFbSyncDown = document.getElementById("btnFbSyncDown");
const btnFbSyncUp = document.getElementById("btnFbSyncUp");
const hdrSub = document.getElementById("hdrSub");

function setFbStatus(txt){
  fbStatus.textContent = txt;
  hdrSub.textContent = `Offline (localStorage) ‚Ä¢ ${txt}`;
}

async function fbConnect(){
  if (fb.ready) return;
  try {
    fb.app = initializeApp(firebaseConfig);
    fb.db = getFirestore(fb.app);
    fb.auth = getAuth(fb.app);

    await signInAnonymously(fb.auth);

    await new Promise((resolve) => {
      const unsub = onAuthStateChanged(fb.auth, (u)=>{
        if (u) {
          fb.user = u;
          fb.ready = true;
          setFbStatus("Firebase: conectado ‚úÖ");
          unsub();
          resolve();
        }
      });
    });
  } catch (e) {
    console.error(e);
    setFbStatus("Firebase: ERRO (veja console)");
    alert("Erro ao conectar Firebase. Confira se Auth An√¥nimo e Firestore est√£o ativados.");
  }
}

function ensureEmpShape(emp){
  emp.vacations = emp.vacations || []; // [{id,startISO,endISO,paidValue}]
  emp.thirteenthPayments = emp.thirteenthPayments || {}; // { "2024": "2024-12-20" }
  emp.boughtVacations = emp.boughtVacations || []; // ["2025-01-10"]
  emp.salaryHistory = emp.salaryHistory || [];
  emp.salaryPayments = emp.salaryPayments || []; // [{id,year,month,paidDateISO,amount}]
  emp.loanBalance = safeNum(emp.loanBalance);
  emp.status = emp.status || "active";
  emp.updatedAt = emp.updatedAt || Date.now();
  return emp;
}

function stripEmpForFirestore(emp){
  // remove campos calculados/tempor√°rios se quiser; por ora envia tudo que √© √∫til
  const e = JSON.parse(JSON.stringify(emp));
  return e;
}

async function fbSyncDown(){
  const ctx = getStoreCtx();
  if (!ctx) return;
  if (!fb.ready) return alert("Conecte o Firebase primeiro.");

  const storeKey = ctx.storeKey;
  const colRef = collection(fb.db, "stores", storeKey, "employees");
  const snap = await getDocs(colRef);

  const list = [];
  snap.forEach(d => {
    const emp = d.data();
    emp.id = emp.id || d.id;
    ensureEmpShape(emp);
    list.push(emp);
  });

  ctx.db.stores[storeKey].employees = list;
  saveDB(ctx.db);

  renderEmployees();
  renderCalcEmployees();
  alert("Baixado do Firebase.");
}

async function fbSyncUp(){
  const ctx = getStoreCtx();
  if (!ctx) return;
  if (!fb.ready) return alert("Conecte o Firebase primeiro.");

  const storeKey = ctx.storeKey;
  const store = ctx.store;
  const emps = store.employees || [];

  // garante doc da store (opcional)
  await setDoc(doc(fb.db, "stores", storeKey), { name: store.name, updatedAt: Date.now() }, { merge:true });

  for (const emp of emps){
    ensureEmpShape(emp);
    emp.updatedAt = Date.now();
    const ref = doc(fb.db, "stores", storeKey, "employees", emp.id);
    await setDoc(ref, stripEmpForFirestore(emp), { merge:true });
  }
  alert("Enviado para o Firebase.");
}

/* ========= UI refs ========= */
const viewLogin = document.getElementById("viewLogin");
const viewApp = document.getElementById("viewApp");
const btnLogout = document.getElementById("btnLogout");
const whoami = document.getElementById("whoami");
const storeName = document.getElementById("storeName");

const tabBtns = Array.from(document.querySelectorAll(".tabBtn"));
const tabPanels = {
  employees: document.getElementById("tab_employees"),
  calc: document.getElementById("tab_calc"),
  settings: document.getElementById("tab_settings"),
};

const empTable = document.getElementById("empTable");
const empSearch = document.getElementById("empSearch");
const empSort = document.getElementById("empSort");
const btnNewEmp = document.getElementById("btnNewEmp");
const btnToggleDismissed = document.getElementById("btnToggleDismissed");

const empEditorWrap = document.getElementById("empEditorWrap");
const empEditorTitle = document.getElementById("empEditorTitle");
const btnCloseEmpEditor = document.getElementById("btnCloseEmpEditor");
const empName = document.getElementById("empName");
const empAdmission = document.getElementById("empAdmission");
const empSalary = document.getElementById("empSalary");
const empLoan = document.getElementById("empLoan");

const payYear = document.getElementById("payYear");
const payMonth = document.getElementById("payMonth");
const payDate = document.getElementById("payDate");
const payAmount = document.getElementById("payAmount");
const btnAddPay = document.getElementById("btnAddPay");
const payTable = document.getElementById("payTable");

const vacStart = document.getElementById("vacStart");
const vacEnd = document.getElementById("vacEnd");
const vacPaidValue = document.getElementById("vacPaidValue");
const btnAddVacation = document.getElementById("btnAddVacation");
const vacationsTable = document.getElementById("vacationsTable");

const thYear = document.getElementById("thYear");
const thDate = document.getElementById("thDate");
const btnAddTh = document.getElementById("btnAddTh");
const thTable = document.getElementById("thTable");

const buyVacDate = document.getElementById("buyVacDate");
const btnAddBuyVac = document.getElementById("btnAddBuyVac");
const buyVacTable = document.getElementById("buyVacTable");

const empActive = document.getElementById("empActive");
const empDismissal = document.getElementById("empDismissal");
const btnSaveEmp = document.getElementById("btnSaveEmp");
const btnAddSalaryChange = document.getElementById("btnAddSalaryChange");
const btnArchiveEmp = document.getElementById("btnArchiveEmp");
const btnDeleteEmp = document.getElementById("btnDeleteEmp");
const salaryHistoryTable = document.getElementById("salaryHistoryTable");

const calcEmp = document.getElementById("calcEmp");
const calcDate = document.getElementById("calcDate");
const calcType = document.getElementById("calcType");
const calcDaysWorked = document.getElementById("calcDaysWorked");
const calcVacMonths = document.getElementById("calcVacMonths");
const calcVacOverdue = document.getElementById("calcVacOverdue");
const calcNoticeDays = document.getElementById("calcNoticeDays");
const calcFgtsBalance = document.getElementById("calcFgtsBalance");
const calcLoanDiscount = document.getElementById("calcLoanDiscount");
const optInss = document.getElementById("optInss");
const optFgts = document.getElementById("optFgts");
const btnCalc = document.getElementById("btnCalc");
const btnPdf = document.getElementById("btnPdf");
const calcResult = document.getElementById("calcResult");

const pinOld = document.getElementById("pinOld");
const pinNew = document.getElementById("pinNew");
const btnChangePin = document.getElementById("btnChangePin");
const btnExport = document.getElementById("btnExport");
const fileImport = document.getElementById("fileImport");
const btnReset = document.getElementById("btnReset");

/* ========= Tabs/Auth ========= */
let currentTab = "employees";
let showDismissed = false;
let editingEmpId = null;

function openTab(tab){
  currentTab = tab;
  for (const k of Object.keys(tabPanels)){
    tabPanels[k].classList.toggle("hidden", k !== tab);
  }
  tabBtns.forEach(b=>{
    const active = b.dataset.tab === tab;
    b.classList.toggle("bg-slate-900", active);
    b.classList.toggle("text-white", active);
    b.classList.toggle("border-slate-900", active);
  });
  if (tab === "employees") renderEmployees();
  if (tab === "calc") renderCalcEmployees();
}

function requireAuth(){
  const s = getSession();
  if (!s) {
    viewApp.classList.add("hidden");
    viewLogin.classList.remove("hidden");
    btnLogout.classList.add("hidden");
    return false;
  }
  viewLogin.classList.add("hidden");
  viewApp.classList.remove("hidden");
  btnLogout.classList.remove("hidden");

  const ctx = getStoreCtx();
  whoami.textContent = ctx.store.managers[s.userKey].label;
  storeName.textContent = ctx.store.name;
  openTab(currentTab);
  return true;
}

/* ========= Employees ========= */
function getEmpById(store, id){ return (store.employees || []).find(e=>e.id===id) || null; }
function upsertEmp(store, emp){
  store.employees = store.employees || [];
  const idx = store.employees.findIndex(e=>e.id===emp.id);
  if (idx >= 0) store.employees[idx] = emp;
  else store.employees.push(emp);
}
function currentSalary(emp){
  if (!emp.salaryHistory?.length) return safeNum(emp.salary || 0);
  const sorted = [...emp.salaryHistory].sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  return safeNum(sorted[sorted.length-1].salary);
}

function listEmployeesForUI(){
  const ctx = getStoreCtx();
  const emps = ctx.store.employees || [];
  const q = (empSearch.value || "").trim().toLowerCase();

  let filtered = emps.filter(e => {
    ensureEmpShape(e);
    const isDismissed = e.status === "dismissed";
    if (!showDismissed && isDismissed) return false;
    if (showDismissed && !isDismissed) return false;
    if (q && !(e.name || "").toLowerCase().includes(q)) return false;
    return true;
  });

  const sortBy = empSort.value;
  filtered.sort((a,b)=>{
    if (sortBy === "name") return (a.name||"").localeCompare(b.name||"");
    if (sortBy === "admission") return (a.admissionDate||"").localeCompare(b.admissionDate||"");
    return 0;
  });

  return filtered;
}

function fmtMonth(m){ return String(m).padStart(2,"0"); }

function renderEmployeeDetails(emp){
  // drop-down com entradas
  ensureEmpShape(emp);

  const pays = (emp.salaryPayments || [])
    .slice()
    .sort((a,b)=> (a.year-b.year) || (a.month-b.month));

  const vacs = (emp.vacations || [])
    .slice()
    .sort((a,b)=> (a.startISO||"").localeCompare(b.startISO||""));

  const thYears = Object.keys(emp.thirteenthPayments || {})
    .sort((a,b)=> Number(a)-Number(b));

  const buys = (emp.boughtVacations || [])
    .slice()
    .sort();

  const payLines = pays.length
    ? pays.map(p => `Sal√°rio recebido no m√™s ${fmtMonth(p.month)}/${p.year} na data ${formatISOToBR(p.paidDateISO)} (${formatBRL(p.amount)})`)
    : ["Nenhum sal√°rio recebido registrado."];

  // >>> pedido: substituir "f√©rias deve tirar at√©" por "Tirou f√©rias na data ..."
  // vamos considerar "data" = in√≠cio do per√≠odo.
  const vacLines = vacs.length
    ? vacs.map((v,idx) => `Tirou f√©rias na data ${formatISOToBR(v.startISO)} (per√≠odo ${formatISOToBR(v.startISO)} a ${formatISOToBR(v.endISO)} ‚Ä¢ ${formatBRL(v.paidValue)})`)
    : ["Nenhuma f√©rias registrada."];

  const thLines = thYears.length
    ? thYears.map(y => `13¬∫ do ano de ${y} foi pago na data ${formatISOToBR(emp.thirteenthPayments[y])}`)
    : ["Nenhum 13¬∫ registrado."];

  const buyLines = buys.length
    ? buys.map(d => `Comprei as f√©rias na data ${formatISOToBR(d)}`)
    : ["Nenhuma compra de f√©rias registrada."];

  function ul(lines){
    return `<ul class="list-disc pl-5 space-y-1">${lines.map(t=>`<li>${escapeHTML(t)}</li>`).join("")}</ul>`;
  }

  return `
    <div class="mt-2 bg-slate-50 border border-slate-200 rounded-2xl p-3">
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <div class="text-xs text-slate-500 font-semibold mb-1">SAL√ÅRIOS RECEBIDOS</div>
          <div class="text-sm text-slate-700">${ul(payLines)}</div>
        </div>
        <div>
          <div class="text-xs text-slate-500 font-semibold mb-1">F√âRIAS</div>
          <div class="text-sm text-slate-700">${ul(vacLines)}</div>
        </div>
        <div>
          <div class="text-xs text-slate-500 font-semibold mb-1">13¬∫</div>
          <div class="text-sm text-slate-700">${ul(thLines)}</div>
        </div>
        <div>
          <div class="text-xs text-slate-500 font-semibold mb-1">COMPRA DE F√âRIAS</div>
          <div class="text-sm text-slate-700">${ul(buyLines)}</div>
        </div>
      </div>
      <div class="mt-3 text-xs text-slate-500">
        Dica: clique em <b>Editar</b> para lan√ßar novos itens.
      </div>
    </div>
  `;
}

function renderEmployees(){
  const rows = listEmployeesForUI();
  btnToggleDismissed.textContent = showDismissed ? "Ver ativos" : "Ver demitidos";

  empTable.innerHTML = rows.map(e=>{
    const sal = currentSalary(e);
    const loan = safeNum(e.loanBalance);
    const detailsId = `det_${e.id.replaceAll(/[^a-zA-Z0-9]/g,"")}`;
    return `
      <tr class="border-b">
        <td class="py-2">
          <button class="text-left font-semibold underline decoration-dotted" onclick="window.__toggleDetails('${detailsId}')">
            ${escapeHTML(e.name || "")}
          </button>
          <div class="text-xs text-slate-500 mt-0.5">
            clique no nome para ver lan√ßamentos
          </div>
        </td>
        <td class="py-2">${formatISOToBR(e.admissionDate) || "‚Äî"}</td>
        <td class="py-2">${formatBRL(sal)}</td>
        <td class="py-2">${formatBRL(loan)}</td>
        <td class="py-2 text-right no-print">
          <button class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs" onclick="window.__openEmpEditor('${e.id}')">
            Editar
          </button>
        </td>
      </tr>
      <tr class="border-b last:border-b-0">
        <td colspan="5" class="pb-3">
          <div id="${detailsId}" class="hidden">
            ${renderEmployeeDetails(e)}
          </div>
        </td>
      </tr>
    `;
  }).join("");

  empEditorWrap.classList.add("hidden");
  editingEmpId = null;
}

window.__toggleDetails = (id) => {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle("hidden");
};

function renderSalaryHistory(emp){
  const hist = (emp.salaryHistory || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  salaryHistoryTable.innerHTML = hist.map(h=>`
    <tr class="border-b last:border-b-0">
      <td class="py-2">${formatISOToBR(h.date) || "‚Äî"}</td>
      <td class="py-2">${formatBRL(h.salary)}</td>
    </tr>
  `).join("");
}

function renderPayments(emp){
  const list = (emp.salaryPayments || []).slice().sort((a,b)=> (a.year-b.year) || (a.month-b.month));
  if (!list.length){
    payTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhum sal√°rio recebido registrado.</td></tr>`;
    return;
  }
  payTable.innerHTML = list.map((p,idx)=>{
    const text = `Sal√°rio recebido no m√™s ${fmtMonth(p.month)}/${p.year} na data ${formatISOToBR(p.paidDateISO)} (${formatBRL(p.amount)})`;
    return `
      <tr class="border-b last:border-b-0">
        <td class="py-2">${escapeHTML(text)}</td>
        <td class="py-2 text-right no-print">
          <button class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs"
            onclick="window.__deletePay('${emp.id}', ${idx})">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");
}

function renderVacations(emp){
  const list = (emp.vacations || []).slice().sort((a,b)=> (a.startISO||"").localeCompare(b.startISO||""));
  if (!list.length){
    vacationsTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhuma f√©rias registrada.</td></tr>`;
    return;
  }
  vacationsTable.innerHTML = list.map((v,idx)=>{
    const text = `Tirou ${idx+1} f√©rias no per√≠odo ${formatISOToBR(v.startISO)} a ${formatISOToBR(v.endISO)} (${formatBRL(v.paidValue)})`;
    return `
      <tr class="border-b last:border-b-0">
        <td class="py-2">${escapeHTML(text)}</td>
        <td class="py-2 text-right no-print">
          <button class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs"
            onclick="window.__deleteVacation('${emp.id}', ${idx})">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");
}

function renderThPayments(emp){
  const years = Object.keys(emp.thirteenthPayments || {}).sort((a,b)=> Number(a)-Number(b));
  if (!years.length){
    thTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhum 13¬∫ registrado.</td></tr>`;
    return;
  }
  thTable.innerHTML = years.map(y=>{
    const iso = emp.thirteenthPayments[y];
    const text = `13¬∫ do ano de ${y} foi pago na data ${formatISOToBR(iso)}`;
    return `
      <tr class="border-b last:border-b-0">
        <td class="py-2">${escapeHTML(text)}</td>
        <td class="py-2 text-right no-print">
          <button class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs"
            onclick="window.__deleteTh('${emp.id}', '${y}')">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");
}

function renderBuyVac(emp){
  const list = (emp.boughtVacations || []).slice().sort();
  if (!list.length){
    buyVacTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhuma compra de f√©rias registrada.</td></tr>`;
    return;
  }
  buyVacTable.innerHTML = list.map((iso,idx)=>{
    const text = `Comprei as f√©rias na data ${formatISOToBR(iso)}`;
    return `
      <tr class="border-b last:border-b-0">
        <td class="py-2">${escapeHTML(text)}</td>
        <td class="py-2 text-right no-print">
          <button class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs"
            onclick="window.__deleteBuyVac('${emp.id}', ${idx})">Excluir</button>
        </td>
      </tr>
    `;
  }).join("");
}

window.__openEmpEditor = (id) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, id);
  if (!emp) return;
  ensureEmpShape(emp);

  editingEmpId = id;
  empEditorTitle.textContent = "Editar funcion√°rio";
  empEditorWrap.classList.remove("hidden");

  empName.value = emp.name || "";
  empAdmission.value = formatISOToBR(emp.admissionDate) || "";
  empSalary.value = currentSalary(emp) || "";
  empLoan.value = safeNum(emp.loanBalance) || "";

  empActive.checked = (emp.status !== "dismissed");
  empDismissal.value = formatISOToBR(emp.dismissalDate) || "";

  // limpa inputs
  payYear.value = ""; payMonth.value = ""; payDate.value = ""; payAmount.value = "";
  vacStart.value = ""; vacEnd.value = ""; vacPaidValue.value = "";
  thYear.value = ""; thDate.value = "";
  buyVacDate.value = "";

  renderSalaryHistory(emp);
  renderPayments(emp);
  renderVacations(emp);
  renderThPayments(emp);
  renderBuyVac(emp);

  renderCalcEmployees();
};

function openNewEmp(){
  editingEmpId = null;
  empEditorTitle.textContent = "Novo funcion√°rio";
  empEditorWrap.classList.remove("hidden");

  empName.value = "";
  empAdmission.value = "";
  empSalary.value = "";
  empLoan.value = "";

  empActive.checked = true;
  empDismissal.value = "";

  payYear.value = ""; payMonth.value = ""; payDate.value = ""; payAmount.value = "";
  vacStart.value = ""; vacEnd.value = ""; vacPaidValue.value = "";
  thYear.value = ""; thDate.value = "";
  buyVacDate.value = "";

  salaryHistoryTable.innerHTML = "";
  payTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhum sal√°rio recebido registrado.</td></tr>`;
  vacationsTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhuma f√©rias registrada.</td></tr>`;
  thTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhum 13¬∫ registrado.</td></tr>`;
  buyVacTable.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="2">Nenhuma compra de f√©rias registrada.</td></tr>`;
}

function loadAndUpdateEmp(updatedEmp){
  const ctx = getStoreCtx();
  const store = ctx.store;
  upsertEmp(store, updatedEmp);
  ctx.db.stores[ctx.storeKey] = store;
  return ctx.db;
}

async function maybePushEmpToFirebase(emp){
  const ctx = getStoreCtx();
  if (!ctx || !fb.ready) return;
  try {
    emp.updatedAt = Date.now();
    await setDoc(doc(fb.db, "stores", ctx.storeKey, "employees", emp.id), stripEmpForFirestore(emp), { merge:true });
  } catch (e) {
    console.error(e);
    // n√£o trava a opera√ß√£o offline
  }
}

async function maybeDeleteEmpFromFirebase(empId){
  const ctx = getStoreCtx();
  if (!ctx || !fb.ready) return;
  try {
    await deleteDoc(doc(fb.db, "stores", ctx.storeKey, "employees", empId));
  } catch (e) {
    console.error(e);
  }
}

function saveEmp(){
  const ctx = getStoreCtx();
  const store = ctx.store;

  const name = (empName.value || "").trim();
  const admissionISO = parseBRToISO(empAdmission.value);

  const salary = safeNum(empSalary.value);
  const loanBalance = safeNum(empLoan.value);

  if (!name) return alert("Informe o nome.");
  if (!admissionISO) return alert("Data de entrada inv√°lida. Use DD/MM/AAAA.");
  if (salary <= 0) return alert("Informe um sal√°rio v√°lido.");

  let emp = null;
  if (editingEmpId) emp = getEmpById(store, editingEmpId);
  if (!emp) {
    emp = {
      id: uid(),
      name: "",
      admissionDate: "",
      salaryHistory: [],
      salaryPayments: [],
      vacations: [],
      thirteenthPayments: {},
      boughtVacations: [],
      loanBalance: 0,
      status: "active",
      dismissalDate: "",
      updatedAt: Date.now()
    };
  }
  ensureEmpShape(emp);

  emp.name = name;
  emp.admissionDate = admissionISO;
  emp.loanBalance = loanBalance;

  if (!empActive.checked) {
    emp.status = "dismissed";
    const disISO = empDismissal.value ? parseBRToISO(empDismissal.value) : null;
    emp.dismissalDate = disISO || todayISO();
  } else {
    emp.status = "active";
    emp.dismissalDate = "";
  }

  // sal√°rio atual vira ‚Äúmudan√ßa‚Äù de hoje (pr√°tico)
  const effectiveDate = todayISO();
  const existingToday = emp.salaryHistory.find(h => h.date === effectiveDate);
  if (existingToday) existingToday.salary = salary;
  else emp.salaryHistory.push({ date: effectiveDate, salary });

  emp.updatedAt = Date.now();

  upsertEmp(store, emp);
  ctx.db.stores[ctx.storeKey] = store;
  saveDB(ctx.db);

  maybePushEmpToFirebase(emp);

  editingEmpId = emp.id;
  renderEmployees();
  window.__openEmpEditor(emp.id);
  alert("Salvo.");
}

function addSalaryChange(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const newSalary = safeNum(prompt("Novo sal√°rio (R$):", String(currentSalary(emp) || "")));
  if (!newSalary || newSalary <= 0) return;

  const br = prompt("Data efetiva (DD/MM/AAAA):", formatISOToBR(todayISO()));
  const iso = parseBRToISO(br);
  if (!iso) return alert("Data inv√°lida. Use DD/MM/AAAA.");

  emp.salaryHistory.push({ date: iso, salary: newSalary });
  emp.updatedAt = Date.now();
  saveDB(loadAndUpdateEmp(emp));
  maybePushEmpToFirebase(emp);

  renderEmployees();
  window.__openEmpEditor(emp.id);
}

function archiveEmp(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  emp.status = "dismissed";
  emp.dismissalDate = emp.dismissalDate || todayISO();
  emp.updatedAt = Date.now();
  saveDB(loadAndUpdateEmp(emp));
  maybePushEmpToFirebase(emp);

  renderEmployees();
  alert("Arquivado como demitido.");
}

function deleteEmp(){
  const ctx = getStoreCtx();
  const store = ctx.store;
  if (!editingEmpId) return alert("Abra um funcion√°rio.");
  const emp = getEmpById(store, editingEmpId);
  if (!emp) return;

  const ok = confirm(`Excluir "${emp.name}"? Isso apaga os dados da loja.`);
  if (!ok) return;

  store.employees = (store.employees || []).filter(e => e.id !== editingEmpId);
  ctx.db.stores[ctx.storeKey] = store;
  saveDB(ctx.db);

  maybeDeleteEmpFromFirebase(editingEmpId);

  editingEmpId = null;
  empEditorWrap.classList.add("hidden");
  renderEmployees();
}

/* ========= Registros: sal√°rio recebido / f√©rias / 13¬∫ / compra ========= */
function addPay(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const year = Number(payYear.value);
  const month = Number(payMonth.value);
  if (!year || year < 2000 || year > 2100) return alert("Ano inv√°lido.");
  if (!month || month < 1 || month > 12) return alert("M√™s inv√°lido (1-12).");

  const paidISO = parseBRToISO(payDate.value);
  if (!paidISO) return alert("Data inv√°lida. Use DD/MM/AAAA.");

  const amount = safeNum(payAmount.value || currentSalary(emp));
  if (amount <= 0) return alert("Valor inv√°lido.");

  // evita duplicar mesmo m√™s/ano
  const exists = emp.salaryPayments.find(p => p.year===year && p.month===month);
  if (exists) {
    const ok = confirm(`J√° existe sal√°rio recebido em ${fmtMonth(month)}/${year}. Substituir?`);
    if (!ok) return;
    exists.paidDateISO = paidISO;
    exists.amount = amount;
  } else {
    emp.salaryPayments.push({ id: uid(), year, month, paidDateISO: paidISO, amount });
  }

  emp.updatedAt = Date.now();
  saveDB(loadAndUpdateEmp(emp));
  maybePushEmpToFirebase(emp);

  payYear.value=""; payMonth.value=""; payDate.value=""; payAmount.value="";
  window.__openEmpEditor(emp.id);
}

window.__deletePay = (empId, idx) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, empId);
  if (!emp) return;
  const ok = confirm("Excluir este sal√°rio recebido?");
  if (!ok) return;
  emp.salaryPayments.splice(idx, 1);
  emp.updatedAt = Date.now();
  saveDB(loadAndUpdateEmp(emp));
  maybePushEmpToFirebase(emp);
  window.__openEmpEditor(emp.id);
};

function addVacationPeriod(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const sISO = parseBRToISO(vacStart.value);
  const eISO = parseBRToISO(vacEnd.value);
  if (!sISO) return alert("Data de in√≠cio inv√°lida.");
  if (!eISO) return alert("Data de fim inv√°lida.");
  if (eISO < sISO) return alert("Fim n√£o pode ser menor que in√≠cio.");

  const paid = safeNum(vacPaidValue.value);
  if (paid <= 0) return alert("Valor pago inv√°lido.");

  emp.vacations.push({ id: uid(), startISO: sISO, endISO: eISO, paidValue: paid });
  emp.updatedAt = Date.now();
  saveDB(loadAndUpdateEmp(emp));
  maybePushEmpToFirebase(emp);

  vacStart.value=""; vacEnd.value=""; vacPaidValue.value="";
  window.__openEmpEditor(emp.id);
}

window.__deleteVacation = (empId, idx) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, empId);
  if (!emp) return;
  const ok = confirm("Excluir esta f√©rias?");
  if (!ok) return;
  emp.vacations.splice(idx, 1);
  emp.updatedAt = Date.now();
  saveDB(loadAndUpdateEmp(emp));
  maybePushEmpToFirebase(emp);
  window.__openEmpEditor(emp.id);
};

function addThPayment(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const year = Number(thYear.value);
  if (!year || year < 2000 || year > 2100) return alert("Ano inv√°lido.");

  const iso = parseBRToISO(thDate.value);
  if (!iso) return alert("Data inv√°lida.");

  emp.thirteenthPayments[String(year)] = iso;
  emp.updatedAt = Date.now();
  saveDB(loadAndUpdateEmp(emp));
  maybePushEmpToFirebase(emp);

  thYear.value=""; thDate.value="";
  window.__openEmpEditor(emp.id);
}

window.__deleteTh = (empId, year) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, empId);
  if (!emp) return;
  const ok = confirm(`Excluir o 13¬∫ do ano ${year}?`);
  if (!ok) return;
  delete emp.thirteenthPayments[year];
  emp.updatedAt = Date.now();
  saveDB(loadAndUpdateEmp(emp));
  maybePushEmpToFirebase(emp);
  window.__openEmpEditor(emp.id);
};

function addBuyVac(){
  const ctx = getStoreCtx();
  const emp = editingEmpId ? getEmpById(ctx.store, editingEmpId) : null;
  if (!emp) return alert("Abra um funcion√°rio.");

  const iso = parseBRToISO(buyVacDate.value);
  if (!iso) return alert("Data inv√°lida.");

  emp.boughtVacations.push(iso);
  emp.updatedAt = Date.now();
  saveDB(loadAndUpdateEmp(emp));
  maybePushEmpToFirebase(emp);

  buyVacDate.value="";
  window.__openEmpEditor(emp.id);
}

window.__deleteBuyVac = (empId, idx) => {
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, empId);
  if (!emp) return;
  const ok = confirm("Excluir esta compra de f√©rias?");
  if (!ok) return;
  emp.boughtVacations.splice(idx, 1);
  emp.updatedAt = Date.now();
  saveDB(loadAndUpdateEmp(emp));
  maybePushEmpToFirebase(emp);
  window.__openEmpEditor(emp.id);
};

/* ========= Rescis√£o (simples) ========= */
function calcINSSSimple(base){
  base = Math.max(0, base);
  return Math.min(base * 0.11, 900);
}
function monthsFor13th(terminationISO){
  if (!terminationISO) return 0;
  const d = new Date(terminationISO + "T00:00:00");
  const m = d.getMonth() + 1;
  const day = d.getDate();
  return (m - 1) + (day >= 15 ? 1 : 0);
}
function labelType(t){
  if (t==="sem_justa_causa") return "Sem justa causa";
  if (t==="pedido_demissao") return "Pedido de demiss√£o";
  if (t==="acordo") return "Acordo";
  return t;
}
function line(label, value){
  return `
    <div class="flex items-center justify-between gap-3">
      <div class="text-sm text-slate-600">${escapeHTML(label)}</div>
      <div class="text-sm font-semibold">${formatBRL(value)}</div>
    </div>
  `;
}
function renderCalcEmployees(){
  const ctx = getStoreCtx();
  if (!ctx) return;
  const emps = (ctx.store.employees || []).filter(e => (e.status || "active") !== "dismissed");
  calcEmp.innerHTML = emps.map(e=>`<option value="${e.id}">${escapeHTML(e.name)}</option>`).join("");
  calcDate.value = calcDate.value || todayISO();
  const selected = getEmpById(ctx.store, calcEmp.value);
  if (selected) calcLoanDiscount.value = safeNum(selected.loanBalance);
}
function doCalc(){
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, calcEmp.value);
  if (!emp) return alert("Selecione um funcion√°rio.");

  const term = calcDate.value;
  if (!term) return alert("Informe a data de desligamento.");

  const salary = currentSalary(emp);
  const daysWorked = Math.max(0, Math.min(31, Number(calcDaysWorked.value||0)));
  const vacMonths = Math.max(0, Math.min(12, Number(calcVacMonths.value||0)));
  const vacOverdue = Math.max(0, Math.min(3, Number(calcVacOverdue.value||0)));
  const noticeDaysRaw = Math.max(0, Math.min(120, Number(calcNoticeDays.value||0)));
  const fgtsBal = safeNum(calcFgtsBalance.value);
  const loanDisc = safeNum(calcLoanDiscount.value);

  const type = calcType.value;
  const daily = salary / 30;

  const saldoSalario = daily * daysWorked;
  const m13 = monthsFor13th(term);
  const decimoTerceiro = (salary / 12) * m13;

  const feriasProp = (salary / 12) * vacMonths;
  const feriasVencidas = salary * vacOverdue;
  const feriasTotal = feriasProp + feriasVencidas;
  const umTerco = feriasTotal / 3;

  let noticeDays = noticeDaysRaw;
  if (type === "pedido_demissao") noticeDays = 0;
  if (type === "acordo") noticeDays = noticeDaysRaw / 2;
  const avisoPrevio = daily * noticeDays;

  let fgtsRate = 0.40;
  if (type === "acordo") fgtsRate = 0.20;
  if (type === "pedido_demissao") fgtsRate = 0.00;
  const multaFgts = (document.getElementById("optFgts").checked ? fgtsBal * fgtsRate : 0);

  const baseInss = saldoSalario + avisoPrevio + decimoTerceiro;
  const inss = (document.getElementById("optInss").checked ? calcINSSSimple(baseInss) : 0);

  const bruto = saldoSalario + decimoTerceiro + feriasTotal + umTerco + avisoPrevio + multaFgts;
  const descontos = inss + loanDisc;
  const liquido = bruto - descontos;

  calcResult.innerHTML = `
    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
      <div class="text-sm text-slate-500">Resumo</div>
      <div class="text-lg font-bold mt-1">${escapeHTML(emp.name)} ‚Ä¢ ${escapeHTML(ctx.store.name)}</div>
      <div class="text-sm text-slate-600">Desligamento: <span class="font-semibold">${term}</span> ‚Ä¢ Tipo: <span class="font-semibold">${escapeHTML(labelType(type))}</span></div>

      <div class="mt-4 grid md:grid-cols-2 gap-3">
        <div class="bg-white border border-slate-200 rounded-2xl p-3">
          <div class="font-semibold">Proventos</div>
          <div class="mt-2 space-y-1">
            ${line("Saldo de sal√°rio", saldoSalario)}
            ${line(`13¬∫ proporcional (${m13}/12)`, decimoTerceiro)}
            ${line(`F√©rias proporcionais (${vacMonths}/12)`, feriasProp)}
            ${line(`F√©rias vencidas (${vacOverdue} per√≠odo)`, feriasVencidas)}
            ${line("1/3 constitucional", umTerco)}
            ${line(`Aviso pr√©vio (${noticeDays.toFixed(0)} dias)`, avisoPrevio)}
            ${line(`Multa FGTS (${(fgtsRate*100).toFixed(0)}%)`, multaFgts)}
          </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-2xl p-3">
          <div class="font-semibold">Descontos</div>
          <div class="mt-2 space-y-1">
            ${line("INSS", inss)}
            ${line("Desconto empr√©stimo", loanDisc)}
          </div>

          <div class="mt-4 border-t border-slate-200 pt-3">
            <div class="flex items-center justify-between">
              <div class="text-sm text-slate-600">Total bruto</div>
              <div class="font-bold">${formatBRL(bruto)}</div>
            </div>
            <div class="flex items-center justify-between mt-1">
              <div class="text-sm text-slate-600">Total descontos</div>
              <div class="font-bold">${formatBRL(descontos)}</div>
            </div>
            <div class="flex items-center justify-between mt-2">
              <div class="text-base font-semibold">Total l√≠quido</div>
              <div class="text-base font-bold">${formatBRL(liquido)}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="text-xs text-slate-500 mt-3">C√°lculo simples e ajust√°vel (modelo pr√°tico).</div>
    </div>
  `;
  return { emp, term, type };
}
function exportPDF(){
  const r = doCalc();
  if (!r) return;

  const ctx = getStoreCtx();
  const win = window.open("", "_blank");
  win.document.open();
  win.document.write(`
    <!doctype html><html lang="pt-BR"><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rescis√£o - ${escapeHTML(r.emp.name)}</title>
    <style>body{font-family:Arial,sans-serif;padding:18px}</style>
    </head><body>
      <h2>Rescis√£o (simples)</h2>
      <div style="color:#666;font-size:12px">
        Loja: <b>${escapeHTML(ctx.store.name)}</b> ‚Ä¢ Funcion√°rio: <b>${escapeHTML(r.emp.name)}</b><br>
        Data: <b>${escapeHTML(r.term)}</b> ‚Ä¢ Tipo: <b>${escapeHTML(labelType(r.type))}</b>
      </div>
      <div style="height:12px"></div>
      ${calcResult.innerHTML}
    </body></html>
  `);
  win.document.close();
  win.onload = () => win.print();
}

/* ========= Settings ========= */
async function changePin(){
  const ctx = getStoreCtx();
  const userKey = ctx.session.userKey;
  const mgr = ctx.store.managers[userKey];

  const oldPin = (pinOld.value || "").trim();
  const newPin = (pinNew.value || "").trim();

  if (newPin.length < 4) return alert("Novo PIN muito curto (m√≠nimo 4).");
  if (!oldPin) return alert("Informe o PIN atual.");

  const oldHash = await hashPin(oldPin);
  if (oldHash !== mgr.pinHash) return alert("PIN atual incorreto.");

  mgr.pinHash = await hashPin(newPin);
  ctx.db.stores[ctx.storeKey] = ctx.store;
  saveDB(ctx.db);

  pinOld.value = "";
  pinNew.value = "";
  alert("PIN alterado.");
}
function exportJSON(){
  const ctx = getStoreCtx();
  const payload = { storeKey: ctx.storeKey, exportedAt: new Date().toISOString(), store: ctx.store };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backup_${ctx.storeKey}_${todayISO()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function importJSON(file){
  const ctx = getStoreCtx();
  const fr = new FileReader();
  fr.onload = () => {
    try {
      const parsed = JSON.parse(fr.result);
      if (!parsed || !parsed.store) return alert("JSON inv√°lido.");
      ctx.db.stores[ctx.storeKey].employees = parsed.store.employees || [];
      saveDB(ctx.db);
      renderEmployees();
      alert("Importado.");
    } catch {
      alert("Falha ao ler JSON.");
    }
  };
  fr.readAsText(file);
}
function resetStore(){
  const ok = confirm("Resetar dados desta loja? (Funcion√°rios e registros).");
  if (!ok) return;
  const ctx = getStoreCtx();
  ctx.db.stores[ctx.storeKey].employees = [];
  saveDB(ctx.db);
  renderEmployees();
  alert("Loja resetada.");
}

/* ========= Events ========= */
document.getElementById("btnLogin").addEventListener("click", async () => {
  const user = document.getElementById("loginUser").value;
  const pin = (document.getElementById("loginPin").value || "").trim();
  if (!pin) return alert("Informe o PIN.");

  await ensureDefaultPins();
  const storeKey = resolveStoreFromUser(user);
  const db = loadDB();
  const mgr = db.stores[storeKey].managers[user];

  const pinHash = await hashPin(pin);
  if (pinHash !== mgr.pinHash) return alert("PIN incorreto.");

  setSession({ userKey: user, storeKey });
  document.getElementById("loginPin").value = "";
  requireAuth();
});

btnLogout.addEventListener("click", () => { clearSession(); requireAuth(); });
tabBtns.forEach(b => b.addEventListener("click", ()=> openTab(b.dataset.tab)));

empSearch.addEventListener("input", renderEmployees);
empSort.addEventListener("change", renderEmployees);

btnNewEmp.addEventListener("click", openNewEmp);
btnCloseEmpEditor.addEventListener("click", ()=> empEditorWrap.classList.add("hidden"));
btnToggleDismissed.addEventListener("click", ()=>{ showDismissed = !showDismissed; renderEmployees(); });

btnSaveEmp.addEventListener("click", saveEmp);
btnAddSalaryChange.addEventListener("click", addSalaryChange);
btnArchiveEmp.addEventListener("click", archiveEmp);
btnDeleteEmp.addEventListener("click", deleteEmp);

btnAddPay.addEventListener("click", addPay);
btnAddVacation.addEventListener("click", addVacationPeriod);
btnAddTh.addEventListener("click", addThPayment);
btnAddBuyVac.addEventListener("click", addBuyVac);

empAdmission.addEventListener("blur", ()=> normalizeBRDateInput(empAdmission));
empDismissal.addEventListener("blur", ()=> { if (empDismissal.value.trim()) normalizeBRDateInput(empDismissal); });
payDate.addEventListener("blur", ()=> { if (payDate.value.trim()) normalizeBRDateInput(payDate); });
vacStart.addEventListener("blur", ()=> { if (vacStart.value.trim()) normalizeBRDateInput(vacStart); });
vacEnd.addEventListener("blur", ()=> { if (vacEnd.value.trim()) normalizeBRDateInput(vacEnd); });
thDate.addEventListener("blur", ()=> { if (thDate.value.trim()) normalizeBRDateInput(thDate); });
buyVacDate.addEventListener("blur", ()=> { if (buyVacDate.value.trim()) normalizeBRDateInput(buyVacDate); });

calcEmp.addEventListener("change", ()=>{
  const ctx = getStoreCtx();
  const emp = getEmpById(ctx.store, calcEmp.value);
  if (emp) calcLoanDiscount.value = safeNum(emp.loanBalance);
});
btnCalc.addEventListener("click", doCalc);
btnPdf.addEventListener("click", exportPDF);

btnChangePin.addEventListener("click", changePin);
btnExport.addEventListener("click", exportJSON);
fileImport.addEventListener("change", (e)=>{
  const f = e.target.files?.[0];
  if (f) importJSON(f);
  e.target.value = "";
});
btnReset.addEventListener("click", resetStore);

/* Firebase buttons */
btnFbConnect.addEventListener("click", fbConnect);
btnFbSyncDown.addEventListener("click", async ()=>{ await fbConnect(); await fbSyncDown(); });
btnFbSyncUp.addEventListener("click", async ()=>{ await fbConnect(); await fbSyncUp(); });

/* Boot */
(async function boot(){
  setFbStatus("Firebase: desconectado");
  await ensureDefaultPins();
  requireAuth();
  calcDate.value = todayISO();
})();
</script>
</body>
</html>
